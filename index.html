<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Stash 路 social</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background-color: black; color: #e7e9ea; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .border-stash { border-color: #2f3336; }
    .hover-stash:hover { background-color: #181818; }
    .text-stash-blue { color: #1d9bf0; }
    .bg-stash-blue { background-color: #1d9bf0; }
    .bg-stash-dark { background-color: #16181c; }
    .skeleton { background: linear-gradient(90deg, #2f3336 25%, #3a3f44 50%, #2f3336 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .compose-box { cursor: pointer; transition: background-color 0.2s; }
    .compose-box:hover { background-color: #080808; }
    /* Consistent avatar sizing */
    .avatar-feed { width: 48px; height: 48px; object-fit: cover; border-radius: 9999px; }
    .avatar-sidebar { width: 40px; height: 40px; object-fit: cover; border-radius: 9999px; }
    .avatar-profile { width: 96px; height: 96px; object-fit: cover; border-radius: 9999px; border: 4px solid black; }
  </style>
</head>
<body class="bg-black text-[#e7e9ea]">

<div id="app" class="max-w-7xl mx-auto flex flex-col lg:flex-row">
  <!-- Left Sidebar (desktop) -->
  <div class="lg:w-1/5 xl:w-1/5 bg-black border-r border-stash hidden lg:block sticky top-0 h-screen overflow-y-auto no-scrollbar">
    <div class="p-4 flex flex-col h-full">
      <!-- SVG Logo -->
      <div class="mb-6">
        <svg width="140" height="56" viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg" class="w-auto h-12">
          <defs>
            <linearGradient id="growthGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#10B981" />
              <stop offset="100%" stop-color="#3B82F6" />
            </linearGradient>
          </defs>
          <path d="M25 100 C 30 40, 80 30, 110 55 C 140 80, 120 130, 70 130 C 30 130, 20 90, 40 70 C 55 55, 80 60, 90 75" stroke="url(#growthGrad)" stroke-width="14" fill="none" stroke-linecap="round" stroke-linejoin="round" />
          <polygon points="145,65 165,40 180,65" fill="#10B981" />
          <text x="190" y="95" font-family="Inter, Arial, Helvetica, sans-serif" font-size="70" font-weight="500" fill="#e7e9ea">stash</text>
        </svg>
      </div>
      <nav class="flex-1 space-y-1">
        <a href="#" class="nav-link flex items-center gap-4 p-3 rounded-full hover-stash text-xl" data-page="home"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="#" class="nav-link flex items-center gap-4 p-3 rounded-full hover-stash text-xl" data-page="explore"><i class="fa-solid fa-hashtag"></i><span>Explore</span></a>
        <a href="#" class="nav-link flex items-center gap-4 p-3 rounded-full hover-stash text-xl" data-page="notifications"><i class="fa-regular fa-bell"></i><span>Notifications</span></a>
        <a href="#" class="nav-link flex items-center gap-4 p-3 rounded-full hover-stash text-xl" data-page="messages"><i class="fa-regular fa-envelope"></i><span>Messages</span></a>
        <a href="#" class="nav-link flex items-center gap-4 p-3 rounded-full hover-stash text-xl" data-page="profile"><i class="fa-regular fa-user"></i><span>Profile</span></a>
        <a href="#" class="nav-link flex items-center gap-4 p-3 rounded-full hover-stash text-xl" data-page="settings"><i class="fa-regular fa-gear"></i><span>Settings</span></a>
        <a href="#" id="admin-link" class="nav-link hidden items-center gap-4 p-3 rounded-full hover-stash text-xl" data-page="admin"><i class="fa-solid fa-crown"></i><span>Admin</span></a>
      </nav>
      <div id="user-info" class="mt-auto pt-4 hidden">
        <div class="flex items-center gap-2 p-2 rounded-full hover-stash cursor-pointer" onclick="goToPage('profile')">
          <img id="user-avatar" src="" class="avatar-sidebar">
          <div class="hidden xl:block">
            <p id="user-display-name" class="font-bold"></p>
            <p id="user-username" class="text-gray-500 text-sm"></p>
          </div>
        </div>
      </div>
      <button id="compose-btn" class="bg-stash-blue text-white rounded-full py-3 px-6 font-bold mt-4 w-full">Post</button>
    </div>
  </div>

  <!-- Mobile bottom navigation -->
  <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-black border-t border-stash flex justify-around py-2 z-10">
    <a href="#" class="nav-link-mobile text-2xl" data-page="home"><i class="fa-solid fa-house"></i></a>
    <a href="#" class="nav-link-mobile text-2xl" data-page="explore"><i class="fa-solid fa-hashtag"></i></a>
    <a href="#" class="nav-link-mobile text-2xl" data-page="notifications"><i class="fa-regular fa-bell"></i></a>
    <a href="#" class="nav-link-mobile text-2xl" data-page="messages"><i class="fa-regular fa-envelope"></i></a>
    <a href="#" class="nav-link-mobile text-2xl" data-page="profile"><i class="fa-regular fa-user"></i></a>
  </div>

  <!-- Main Content Area -->
  <main id="main-content" class="flex-1 border-x border-stash min-h-screen pb-20 lg:pb-0"></main>

  <!-- Right Sidebar (desktop) -->
  <div class="hidden lg:block w-1/4 xl:w-1/5 p-4 space-y-4">
    <div class="bg-stash-dark rounded-xl p-4">
      <h2 class="text-xl font-bold mb-2">Search</h2>
      <input type="text" id="search-input" placeholder="Search Stash" class="w-full bg-black border border-stash rounded-full py-2 px-4 text-white">
    </div>
    <div class="bg-stash-dark rounded-xl p-4">
      <h2 class="text-xl font-bold mb-2">Trends for you</h2>
      <div id="trends-list" class="space-y-3"></div>
    </div>
    <div class="bg-stash-dark rounded-xl p-4">
      <h2 class="text-xl font-bold mb-2">Who to follow</h2>
      <div id="who-to-follow" class="space-y-3"></div>
    </div>
  </div>
</div>

<!-- Compose Post Modal -->
<div id="compose-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-lg p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Compose post</h2>
      <button onclick="closeModal('compose-modal')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
    </div>
    <form id="compose-form">
      <textarea id="compose-content" rows="4" placeholder="What's happening?" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required></textarea>
      <input type="url" id="compose-image" placeholder="Image URL (optional)" class="w-full bg-black border border-stash rounded-lg p-3 mt-2 text-white">
      <input type="url" id="compose-video" placeholder="Video URL (YouTube/Vimeo)" class="w-full bg-black border border-stash rounded-lg p-3 mt-2 text-white">
      <div class="flex items-center gap-2 mt-3">
        <input type="checkbox" id="compose-poll" class="w-4 h-4">
        <label for="compose-poll" class="text-sm">Add poll (Home/Draw/Away)</label>
      </div>
      <button type="submit" class="bg-stash-blue text-white rounded-full py-3 px-6 font-bold mt-4 w-full">Post</button>
    </form>
  </div>
</div>

<!-- Edit Post Modal -->
<div id="edit-post-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-lg p-6">
    <h2 class="text-2xl font-bold mb-4">Edit post</h2>
    <form id="edit-post-form">
      <input type="hidden" id="edit-post-id">
      <textarea id="edit-post-content" rows="4" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required></textarea>
      <input type="url" id="edit-post-image" placeholder="Image URL" class="w-full bg-black border border-stash rounded-lg p-3 mt-2 text-white">
      <button type="submit" class="bg-stash-blue text-white rounded-full py-2 px-4 font-bold mt-3">Update</button>
    </form>
  </div>
</div>

<!-- Reply Modal -->
<div id="reply-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-lg p-6">
    <h2 class="text-2xl font-bold mb-4">Reply</h2>
    <form id="reply-form">
      <input type="hidden" id="reply-post-id">
      <textarea id="reply-content" rows="3" placeholder="Post your reply" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required></textarea>
      <button type="submit" class="bg-stash-blue text-white rounded-full py-2 px-4 font-bold mt-3">Reply</button>
    </form>
  </div>
</div>

<!-- Admin Dashboard Modal -->
<div id="admin-modal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto p-4">
  <div class="bg-black min-h-screen rounded-xl p-6 max-w-6xl mx-auto">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Admin Dashboard</h1>
      <button onclick="closeModal('admin-modal')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-3xl"></i></button>
    </div>
    <div class="border-b border-stash mb-6 overflow-x-auto">
      <nav class="flex gap-6">
        <button class="admin-tab active text-stash-blue border-b-2 border-stash-blue pb-2" data-tab="dashboard">Dashboard</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-2" data-tab="users">Users</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-2" data-tab="posts">Posts</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-2" data-tab="trends">Trends</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-2" data-tab="ads">Ads</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-2" data-tab="analytics">Analytics</button>
      </nav>
    </div>
    <div id="admin-panes"></div>
  </div>
</div>

<!-- Login/Signup Modal -->
<div id="auth-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-md p-6">
    <h2 class="text-2xl font-bold mb-4 text-center">Welcome to Stash</h2>
    <form id="login-form" class="space-y-3">
      <input type="email" id="login-email" placeholder="Email" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <input type="password" id="login-password" placeholder="Password" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <button type="submit" class="bg-stash-blue text-white rounded-full py-3 px-6 font-bold w-full">Log in</button>
    </form>
    <p class="text-center text-gray-500 my-2">or</p>
    <form id="signup-form" class="space-y-3">
      <input type="email" id="signup-email" placeholder="Email" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <input type="password" id="signup-password" placeholder="Password" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <input type="text" id="signup-username" placeholder="Username" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <button type="submit" class="bg-green-600 text-white rounded-full py-3 px-6 font-bold w-full">Create account</button>
    </form>
  </div>
</div>

<script>
  // ==================== CONFIG ====================
  const SUPABASE_URL = 'https://vcopwxjcjraddqwxmxkb.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_9b2BZuqv8hms1kXt9hBXnQ_GBCzLmSn'; // REPLACE WITH YOUR KEY
  const { createClient } = supabase;
  const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ==================== STATE ====================
  let currentUser = null;
  let currentProfile = null;
  let currentPage = 'home';
  let posts = [];
  let trends = [];
  let suggestions = [];
  let pageOffset = 0;
  const POSTS_PER_PAGE = 10;
  let loading = false;
  let hasMore = true;
  let viewedPosts = new Set();
  let notificationsInterval = null;
  let messagesInterval = null;
  let scrollListener = null;

  // ==================== DOM HELPERS ====================
  function escapeHTML(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"]/g, function(m) {
      if (m === '&') return '&amp;';
      if (m === '<') return '&lt;';
      if (m === '>') return '&gt;';
      if (m === '"') return '&quot;';
      return m;
    });
  }

  function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h`;
    const days = Math.floor(hours / 24);
    return `${days}d`;
  }

  function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
  }

  // Validate video URL (only YouTube and Vimeo)
  function validateVideoUrl(url) {
    if (!url) return null;
    const ytRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/;
    const vimeoRegex = /^(https?:\/\/)?(www\.)?(vimeo\.com\/)([0-9]+)/;
    if (ytRegex.test(url)) {
      const match = url.match(/(?:v=|\/)([a-zA-Z0-9_-]+)/);
      return `https://www.youtube.com/embed/${match[1]}`;
    } else if (vimeoRegex.test(url)) {
      const match = url.match(/([0-9]+)$/);
      return `https://player.vimeo.com/video/${match[1]}`;
    }
    return null;
  }

  // ==================== AUTH ====================
  async function fetchCurrentProfile() {
    if (!currentUser) { currentProfile = null; return; }
    const { data, error } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    if (!error) currentProfile = data;
  }

  async function updateAuthUI(user) {
    await fetchCurrentProfile();
    const authModal = document.getElementById('auth-modal');
    if (user) {
      authModal.classList.add('hidden');
      document.getElementById('user-info').classList.remove('hidden');
      document.getElementById('user-avatar').src = currentProfile?.avatar_url || 'https://via.placeholder.com/40';
      document.getElementById('user-display-name').textContent = currentProfile?.display_name || 'User';
      document.getElementById('user-username').textContent = '@' + (currentProfile?.username || '');
      if (currentProfile?.is_admin) document.getElementById('admin-link').classList.remove('hidden');
      else document.getElementById('admin-link').classList.add('hidden');
      startPolling();
    } else {
      authModal.classList.remove('hidden');
      document.getElementById('user-info').classList.add('hidden');
      document.getElementById('admin-link').classList.add('hidden');
      if (notificationsInterval) clearInterval(notificationsInterval);
      if (messagesInterval) clearInterval(messagesInterval);
    }
    loadPage(currentPage);
  }

  _supabase.auth.getSession().then(({ data: { session } }) => {
    currentUser = session?.user ?? null;
    updateAuthUI(currentUser);
  });
  _supabase.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user ?? null;
    updateAuthUI(currentUser);
  });

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const { error } = await _supabase.auth.signInWithPassword({ email, password });
    if (error) alert('Login error: ' + error.message);
  });

  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const username = document.getElementById('signup-username').value;
    const { error } = await _supabase.auth.signUp({
      email,
      password,
      options: { data: { username } }
    });
    if (error) alert('Signup error: ' + error.message);
    else alert('Check your email for confirmation!');
  });

  // ==================== ROUTING ====================
  document.querySelectorAll('.nav-link, .nav-link-mobile').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const page = link.dataset.page;
      goToPage(page);
    });
  });

  function goToPage(page) {
    currentPage = page;
    document.querySelectorAll('.nav-link, .nav-link-mobile').forEach(l => l.classList.remove('text-stash-blue'));
    document.querySelectorAll(`[data-page="${page}"]`).forEach(l => l.classList.add('text-stash-blue'));
    if (page === 'admin' && currentProfile?.is_admin) {
      openAdminDashboard();
      return;
    }
    loadPage(page);
  }

  async function loadPage(page) {
    mainContent.innerHTML = getSkeletonForPage(page);
    if (page === 'home') await loadHomeFeed(true);
    else if (page === 'explore') await loadExplore();
    else if (page === 'notifications') await loadNotifications();
    else if (page === 'messages') await loadMessages();
    else if (page === 'profile') await loadProfile(currentUser?.id);
    else if (page === 'settings') await loadSettings();
  }

  function getSkeletonForPage(page) {
    if (page === 'home') {
      let html = '';
      for (let i = 0; i < 5; i++) {
        html += `
          <div class="p-4 border-b border-stash">
            <div class="flex gap-3">
              <div class="skeleton w-12 h-12 rounded-full"></div>
              <div class="flex-1 space-y-2">
                <div class="skeleton h-4 w-24"></div>
                <div class="skeleton h-4 w-full"></div>
                <div class="skeleton h-4 w-2/3"></div>
              </div>
            </div>
          </div>
        `;
      }
      return html;
    }
    return '<div class="p-4 text-center">Loading...</div>';
  }

  // ==================== HOME FEED ====================
  async function loadHomeFeed(reset = true) {
    if (reset) { pageOffset = 0; hasMore = true; }
    if (!hasMore || loading) return;
    loading = true;

    const { data: fetchedPosts, error } = await _supabase
      .from('posts')
      .select('*')
      .is('parent_id', null)
      .order('created_at', { ascending: false })
      .range(pageOffset, pageOffset + POSTS_PER_PAGE - 1);
    if (error) { console.error(error); loading = false; return; }

    if (reset) posts = fetchedPosts;
    else posts = [...posts, ...fetchedPosts];
    pageOffset += fetchedPosts.length;
    hasMore = fetchedPosts.length === POSTS_PER_PAGE;

    await enrichPosts(posts.slice(reset ? 0 : posts.length - fetchedPosts.length));
    renderHomeFeed(reset);
    loading = false;
  }

  async function enrichPosts(postList) {
    const userIds = [...new Set(postList.map(p => p.user_id))];
    const { data: profiles } = await _supabase.from('profiles').select('id, username, display_name, avatar_url, is_verified').in('id', userIds);
    const profileMap = Object.fromEntries((profiles || []).map(p => [p.id, p]));

    for (let post of postList) {
      post.profile = profileMap[post.user_id] || { username: 'anonymous', display_name: 'Anonymous', avatar_url: null };
      const { count: likes } = await _supabase.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', post.id);
      post.likes_count = likes || 0;
      const { count: retweets } = await _supabase.from('retweets').select('*', { count: 'exact', head: true }).eq('post_id', post.id);
      post.retweets_count = retweets || 0;
      const { count: replies } = await _supabase.from('posts').select('*', { count: 'exact', head: true }).eq('parent_id', post.id);
      post.replies_count = replies || 0;
      if (currentUser) {
        const { data: userLike } = await _supabase.from('likes').select('id').eq('post_id', post.id).eq('user_id', currentUser.id).maybeSingle();
        post.liked_by_me = !!userLike;
        const { data: userRetweet } = await _supabase.from('retweets').select('id').eq('post_id', post.id).eq('user_id', currentUser.id).maybeSingle();
        post.retweeted_by_me = !!userRetweet;
        const { data: userBookmark } = await _supabase.from('bookmarks').select('id').eq('post_id', post.id).eq('user_id', currentUser.id).maybeSingle();
        post.bookmarked_by_me = !!userBookmark;
      }
      if (!viewedPosts.has(post.id)) {
        viewedPosts.add(post.id);
        await _supabase.rpc('increment_post_view', { post_id: post.id });
      }
    }
  }

  function renderHomeFeed(reset) {
    const composeHtml = `
      <div class="p-4 border-b border-stash compose-box" onclick="document.getElementById('compose-modal').classList.remove('hidden')">
        <div class="flex gap-3">
          <img src="${currentUser ? (currentProfile?.avatar_url || 'https://via.placeholder.com/48') : 'https://via.placeholder.com/48'}" class="avatar-feed">
          <div class="flex-1">
            <div class="bg-black border border-stash rounded-2xl p-3 text-gray-500">
              What's happening?
            </div>
            <div class="flex gap-4 mt-2 text-gray-500">
              <i class="fa-regular fa-image"></i>
              <i class="fa-regular fa-video"></i>
              <i class="fa-regular fa-chart-bar"></i>
            </div>
          </div>
        </div>
      </div>
    `;

    let feedHtml = '';
    posts.forEach(post => {
      feedHtml += renderPost(post);
    });

    const fullHtml = composeHtml + feedHtml;

    if (reset) mainContent.innerHTML = fullHtml;
    else mainContent.insertAdjacentHTML('beforeend', feedHtml);

    attachPostListeners();

    if (scrollListener) window.removeEventListener('scroll', scrollListener);
    scrollListener = () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
        loadHomeFeed(false);
      }
    };
    window.addEventListener('scroll', scrollListener);
  }

  function renderPost(post) {
    const escapedName = escapeHTML(post.profile?.display_name || 'User');
    const escapedUsername = escapeHTML(post.profile?.username);
    const escapedAvatar = escapeHTML(post.profile?.avatar_url || 'https://via.placeholder.com/48');
    const escapedContent = escapeHTML(post.content || '');
    const likeIcon = post.liked_by_me ? 'fa-solid' : 'fa-regular';
    const retweetIcon = post.retweeted_by_me ? 'fa-solid' : 'fa-regular';
    const bookmarkIcon = post.bookmarked_by_me ? 'fa-solid' : 'fa-regular';
    const canEdit = currentUser && (currentUser.id === post.user_id || currentProfile?.is_admin);
    const editButton = canEdit ? `<button class="edit-post-btn text-gray-500 hover:text-stash-blue ml-2" data-post-id="${post.id}"><i class="fa-regular fa-pen-to-square"></i></button>` : '';

    let pollHtml = '';
    if (post.poll_options) {
      const options = JSON.parse(post.poll_options);
      pollHtml = '<div class="mt-2 space-y-1">';
      options.forEach((opt, idx) => {
        pollHtml += `<div class="bg-stash-dark p-2 rounded">${opt}</div>`;
      });
      pollHtml += '</div>';
    }

    return `
      <div class="p-4 border-b border-stash hover:bg-[#080808] transition" data-post-id="${post.id}">
        <div class="flex gap-3">
          <img src="${escapedAvatar}" class="avatar-feed cursor-pointer" onclick="goToProfile('${post.user_id}')">
          <div class="flex-1">
            <div class="flex items-center gap-1 flex-wrap">
              <span class="font-bold">${escapedName}</span>
              ${post.profile?.is_verified ? '<i class="fa-solid fa-circle-check text-stash-blue text-sm"></i>' : ''}
              <span class="text-gray-500 text-sm">@${escapedUsername} 路 ${timeAgo(post.created_at)}</span>
              ${editButton}
            </div>
            <p class="mt-1">${escapedContent}</p>
            ${post.image_url ? `<img src="${escapeHTML(post.image_url)}" class="rounded-xl mt-2 max-h-96 object-cover">` : ''}
            ${post.video_url ? `<div class="mt-2"><iframe src="${escapeHTML(post.video_url)}" class="w-full h-64 rounded-xl" frameborder="0" allowfullscreen></iframe></div>` : ''}
            ${pollHtml}
            <div class="flex justify-between mt-3 text-gray-500 max-w-md">
              <button class="reply-btn flex items-center gap-1 hover:text-stash-blue" data-post-id="${post.id}"><i class="fa-regular fa-comment"></i> ${post.replies_count}</button>
              <button class="retweet-btn flex items-center gap-1 hover:text-green-500" data-post-id="${post.id}"><i class="${retweetIcon} fa-retweet"></i> ${post.retweets_count}</button>
              <button class="like-btn flex items-center gap-1 hover:text-red-500" data-post-id="${post.id}"><i class="${likeIcon} fa-heart"></i> ${post.likes_count}</button>
              <button class="bookmark-btn flex items-center gap-1 hover:text-stash-blue" data-post-id="${post.id}"><i class="${bookmarkIcon} fa-bookmark"></i></button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function attachPostListeners() {
    document.querySelectorAll('.like-btn').forEach(btn => btn.addEventListener('click', handleLike));
    document.querySelectorAll('.retweet-btn').forEach(btn => btn.addEventListener('click', handleRetweet));
    document.querySelectorAll('.bookmark-btn').forEach(btn => btn.addEventListener('click', handleBookmark));
    document.querySelectorAll('.reply-btn').forEach(btn => btn.addEventListener('click', openReplyModal));
    document.querySelectorAll('.edit-post-btn').forEach(btn => btn.addEventListener('click', openEditModal));
  }

  // ==================== INTERACTIONS ====================
  async function handleLike(e) {
    if (!currentUser) { alert('Please log in'); return; }
    const btn = e.currentTarget;
    const postId = btn.dataset.postId;
    const post = posts.find(p => p.id === postId);
    const wasLiked = btn.querySelector('i').classList.contains('fa-solid');
    const countSpan = btn.querySelector('span');
    if (wasLiked) {
      btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
      countSpan.textContent = parseInt(countSpan.textContent) - 1;
    } else {
      btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
      countSpan.textContent = parseInt(countSpan.textContent) + 1;
    }
    let error;
    if (wasLiked) {
      ({ error } = await _supabase.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id));
    } else {
      ({ error } = await _supabase.from('likes').insert({ user_id: currentUser.id, post_id: postId }));
      if (!error && post) createNotification(post.user_id, 'like', postId);
    }
    if (error) {
      if (wasLiked) {
        btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
        countSpan.textContent = parseInt(countSpan.textContent) + 1;
      } else {
        btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
        countSpan.textContent = parseInt(countSpan.textContent) - 1;
      }
      alert('Error');
    }
  }

  async function handleRetweet(e) {
    if (!currentUser) return;
    const btn = e.currentTarget;
    const postId = btn.dataset.postId;
    const post = posts.find(p => p.id === postId);
    const wasRetweeted = btn.querySelector('i').classList.contains('fa-solid');
    const countSpan = btn.querySelector('span');
    if (wasRetweeted) {
      btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
      countSpan.textContent = parseInt(countSpan.textContent) - 1;
      await _supabase.from('retweets').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
      countSpan.textContent = parseInt(countSpan.textContent) + 1;
      await _supabase.from('retweets').insert({ user_id: currentUser.id, post_id: postId });
      if (post) createNotification(post.user_id, 'retweet', postId);
    }
  }

  async function handleBookmark(e) {
    if (!currentUser) return;
    const btn = e.currentTarget;
    const postId = btn.dataset.postId;
    const wasBookmarked = btn.querySelector('i').classList.contains('fa-solid');
    if (wasBookmarked) {
      btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
      await _supabase.from('bookmarks').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
      await _supabase.from('bookmarks').insert({ user_id: currentUser.id, post_id: postId });
    }
  }

  function openReplyModal(e) {
    const postId = e.currentTarget.dataset.postId;
    document.getElementById('reply-post-id').value = postId;
    document.getElementById('reply-modal').classList.remove('hidden');
  }

  document.getElementById('reply-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;
    const postId = document.getElementById('reply-post-id').value;
    const content = document.getElementById('reply-content').value.trim();
    if (!content) return;
    const { error } = await _supabase.from('posts').insert({
      user_id: currentUser.id,
      parent_id: postId,
      content
    });
    if (!error) {
      closeModal('reply-modal');
      document.getElementById('reply-content').value = '';
      const post = posts.find(p => p.id === postId);
      if (post) createNotification(post.user_id, 'reply', postId);
      loadHomeFeed(true);
    } else alert('Reply failed');
  });

  async function createNotification(targetUserId, type, postId = null) {
    if (targetUserId === currentUser.id) return;
    await _supabase.from('notifications').insert({
      user_id: targetUserId,
      type,
      actor_id: currentUser.id,
      post_id: postId
    });
  }

  // ==================== EDIT POST ====================
  function openEditModal(e) {
    const postId = e.currentTarget.dataset.postId;
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    document.getElementById('edit-post-id').value = post.id;
    document.getElementById('edit-post-content').value = post.content || '';
    document.getElementById('edit-post-image').value = post.image_url || '';
    document.getElementById('edit-post-modal').classList.remove('hidden');
  }

  document.getElementById('edit-post-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;
    const postId = document.getElementById('edit-post-id').value;
    const content = document.getElementById('edit-post-content').value.trim();
    const image_url = document.getElementById('edit-post-image').value.trim() || null;
    if (!content) { alert('Content cannot be empty'); return; }
    const { error } = await _supabase
      .from('posts')
      .update({ content, image_url })
      .eq('id', postId)
      .eq('user_id', currentUser.id);
    if (!error) {
      closeModal('edit-post-modal');
      loadHomeFeed(true);
    } else alert('Edit failed: ' + error.message);
  });

  // ==================== COMPOSE ====================
  document.getElementById('compose-btn').addEventListener('click', () => {
    document.getElementById('compose-modal').classList.remove('hidden');
  });

  document.getElementById('compose-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;
    const content = document.getElementById('compose-content').value.trim();
    const image_url = document.getElementById('compose-image').value;
    const video_url = validateVideoUrl(document.getElementById('compose-video').value);
    const isPoll = document.getElementById('compose-poll').checked;
    if (!content && !image_url && !video_url) { alert('Post cannot be empty'); return; }
    const poll_options = isPoll ? JSON.stringify(['Home', 'Draw', 'Away']) : null;
    const { error } = await _supabase.from('posts').insert({
      user_id: currentUser.id,
      content,
      image_url: image_url || null,
      video_url: video_url,
      poll_options
    });
    if (!error) {
      closeModal('compose-modal');
      document.getElementById('compose-content').value = '';
      document.getElementById('compose-image').value = '';
      document.getElementById('compose-video').value = '';
      document.getElementById('compose-poll').checked = false;
      loadHomeFeed(true);
    } else alert('Error: ' + error.message);
  });

  // ==================== NOTIFICATIONS ====================
  async function loadNotifications() {
    if (!currentUser) return;
    const { data } = await _supabase
      .from('notifications')
      .select('*, actor:actor_id(username, display_name, avatar_url), post:post_id(content)')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });
    let html = '<div class="p-4"><h2 class="text-2xl font-bold mb-4">Notifications</h2>';
    if (!data || data.length === 0) html += '<p class="text-gray-500">No notifications yet.</p>';
    else {
      data.forEach(n => {
        const actor = n.actor?.display_name || n.actor?.username || 'Someone';
        const time = timeAgo(n.created_at);
        let text = '';
        if (n.type === 'like') text = `liked your post`;
        else if (n.type === 'retweet') text = `retweeted your post`;
        else if (n.type === 'reply') text = `replied to your post`;
        else if (n.type === 'follow') text = `followed you`;
        html += `<div class="border-b border-stash py-3">${actor} ${text} 路 ${time}</div>`;
      });
    }
    html += '</div>';
    mainContent.innerHTML = html;
  }

  function startPolling() {
    if (notificationsInterval) clearInterval(notificationsInterval);
    notificationsInterval = setInterval(() => {
      if (currentPage === 'notifications') loadNotifications();
    }, 30000);
  }

  // ==================== MESSAGES ====================
  async function loadMessages() {
    if (!currentUser) return;
    const { data } = await _supabase
      .from('messages')
      .select('*, sender:sender_id(username, display_name, avatar_url), recipient:recipient_id(username)')
      .or(`sender_id.eq.${currentUser.id},recipient_id.eq.${currentUser.id}`)
      .order('created_at', { ascending: false });
    const conversations = {};
    (data || []).forEach(m => {
      const otherId = m.sender_id === currentUser.id ? m.recipient_id : m.sender_id;
      if (!conversations[otherId]) {
        conversations[otherId] = { user: m.sender_id === currentUser.id ? m.recipient : m.sender, messages: [] };
      }
      conversations[otherId].messages.push(m);
    });
    let html = '<div class="p-4"><h2 class="text-2xl font-bold mb-4">Messages</h2>';
    if (Object.keys(conversations).length === 0) html += '<p class="text-gray-500">No messages yet.</p>';
    else {
      for (let id in conversations) {
        const conv = conversations[id];
        const lastMsg = conv.messages[0];
        html += `<div class="border-b border-stash py-3 flex gap-3">
          <img src="${conv.user?.avatar_url || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover">
          <div>
            <p class="font-bold">${conv.user?.display_name || conv.user?.username}</p>
            <p class="text-sm text-gray-500">${escapeHTML(lastMsg.content.substring(0,50))}</p>
          </div>
        </div>`;
      }
    }
    html += '</div>';
    mainContent.innerHTML = html;
  }

  // ==================== EXPLORE & SEARCH ====================
  async function loadExplore() {
    const { data: trendsData } = await _supabase.from('trends').select('*').order('post_count', { ascending: false }).limit(10);
    trends = trendsData || [];
    let html = '<div class="p-4"><h2 class="text-2xl font-bold mb-4">Explore</h2>';
    html += '<div class="space-y-2">';
    trends.forEach(t => {
      html += `<div class="p-3 border border-stash rounded">#${t.hashtag} 路 ${t.post_count} posts</div>`;
    });
    html += '</div></div>';
    mainContent.innerHTML = html;
  }

  document.getElementById('search-input')?.addEventListener('keyup', async (e) => {
    if (e.key === 'Enter') {
      const query = e.target.value.trim();
      if (!query) return;
      const { data } = await _supabase
        .from('posts')
        .select('*')
        .ilike('content', `%${query}%`)
        .is('parent_id', null)
        .order('created_at', { ascending: false });
      if (data) {
        await enrichPosts(data);
        let html = '<div class="p-4"><h2 class="text-xl font-bold mb-4">Search results</h2>';
        if (data.length === 0) html += '<p>No posts found.</p>';
        else data.forEach(p => html += renderPost(p));
        html += '</div>';
        mainContent.innerHTML = html;
        attachPostListeners();
      }
    }
  });

  // ==================== PROFILE ====================
  async function loadProfile(userId) {
    if (!userId) userId = currentUser.id;
    const { data: profile } = await _supabase.from('profiles').select('*').eq('id', userId).single();
    const { data: userPosts } = await _supabase.from('posts').select('*').eq('user_id', userId).is('parent_id', null).order('created_at', { ascending: false });
    await enrichPosts(userPosts || []);
    let html = `
      <div class="relative">
        <div class="h-32 bg-stash-dark"></div>
        <img src="${profile?.avatar_url || 'https://via.placeholder.com/96'}" class="avatar-profile absolute -bottom-12 left-4">
        <div class="pt-16 p-4">
          <div class="flex justify-between">
            <div>
              <h2 class="text-2xl font-bold">${escapeHTML(profile?.display_name || 'User')}</h2>
              <p class="text-gray-500">@${escapeHTML(profile?.username)}</p>
            </div>
            ${userId === currentUser?.id ? '<button onclick="goToPage(\'settings\')" class="bg-stash-blue text-white px-4 py-2 rounded-full">Edit profile</button>' : '<button onclick="followUser(\''+userId+'\')" class="bg-stash-blue text-white px-4 py-2 rounded-full">Follow</button>'}
          </div>
          <p class="mt-2">${escapeHTML(profile?.bio || '')}</p>
          <div class="flex gap-4 mt-2 text-gray-500">
            <span><span class="font-bold text-white">${profile?.following_count || 0}</span> Following</span>
            <span><span class="font-bold text-white">${profile?.followers_count || 0}</span> Followers</span>
          </div>
        </div>
      </div>
    `;
    userPosts?.forEach(p => html += renderPost(p));
    mainContent.innerHTML = html;
    attachPostListeners();
  }

  async function followUser(userId) {
    if (!currentUser) return;
    await _supabase.from('follows').insert({ follower_id: currentUser.id, following_id: userId });
    const { error } = await _supabase.rpc('increment_follow_counts', { follower: currentUser.id, following: userId });
    if (error) console.warn('RPC error, updating manually', error);
    else {
      if (currentProfile) currentProfile.following_count++;
      if (currentPage === 'profile') loadProfile(userId);
    }
    createNotification(userId, 'follow');
    loadWhoToFollow();
  }

  // ==================== SETTINGS ====================
  async function loadSettings() {
    if (!currentUser) return;
    const { data: settings } = await _supabase.from('user_settings').select('*').eq('user_id', currentUser.id).single();
    mainContent.innerHTML = `
      <div class="p-4 max-w-lg">
        <h2 class="text-2xl font-bold mb-4">Settings</h2>
        <form id="settings-form" class="space-y-4">
          <div>
            <label class="block text-sm">Display name</label>
            <input type="text" id="settings-display-name" value="${escapeHTML(currentProfile?.display_name || '')}" class="w-full bg-black border border-stash rounded-lg p-3">
          </div>
          <div>
            <label class="block text-sm">Bio</label>
            <textarea id="settings-bio" rows="3" class="w-full bg-black border border-stash rounded-lg p-3">${escapeHTML(currentProfile?.bio || '')}</textarea>
          </div>
          <div>
            <label class="block text-sm">Avatar URL</label>
            <input type="url" id="settings-avatar" value="${escapeHTML(currentProfile?.avatar_url || '')}" class="w-full bg-black border border-stash rounded-lg p-3">
          </div>
          <div>
            <label class="block text-sm">Email notifications</label>
            <input type="checkbox" id="settings-email" ${settings?.email_notifications ? 'checked' : ''} class="mt-1">
          </div>
          <button type="submit" class="bg-stash-blue text-white px-6 py-2 rounded-full">Save</button>
        </form>
        <hr class="my-4 border-stash">
        <button onclick="changePassword()" class="bg-gray-700 text-white px-6 py-2 rounded-full">Change password</button>
      </div>
    `;
    document.getElementById('settings-form').addEventListener('submit', saveSettings);
  }

  async function saveSettings(e) {
    e.preventDefault();
    const display_name = document.getElementById('settings-display-name').value.trim();
    const bio = document.getElementById('settings-bio').value.trim();
    const avatar_url = document.getElementById('settings-avatar').value.trim() || null;
    const email_notifications = document.getElementById('settings-email').checked;
    await _supabase.from('profiles').update({ display_name, bio, avatar_url }).eq('id', currentUser.id);
    await _supabase.from('user_settings').update({ email_notifications }).eq('user_id', currentUser.id);
    alert('Settings saved');
    fetchCurrentProfile();
    updateAuthUI(currentUser);
  }

  async function changePassword() {
    const newPass = prompt('Enter new password (min 6 characters)');
    if (newPass && newPass.length >= 6) {
      const { error } = await _supabase.auth.updateUser({ password: newPass });
      if (error) alert(error.message);
      else alert('Password updated');
    }
  }

  // ==================== ADMIN DASHBOARD ====================
  window.openAdminDashboard = async () => {
    document.getElementById('admin-modal').classList.remove('hidden');
    await loadAdminDashboard();
  };

  async function loadAdminDashboard() {
    const { count: users } = await _supabase.from('profiles').select('*', { count: 'exact', head: true });
    const { count: postsCount } = await _supabase.from('posts').select('*', { count: 'exact', head: true });
    const { data: viewsData } = await _supabase.from('posts').select('views');
    const totalViews = (viewsData || []).reduce((a,b) => a + (b.views||0), 0);
    const { data: earnings } = await _supabase.from('user_earnings').select('total_earned');
    const totalEarnings = (earnings || []).reduce((a,b) => a + (b.total_earned||0), 0);

    const panes = `
      <div class="tab-pane active" data-pane="dashboard">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="bg-stash-dark p-4 rounded">Users: ${users || 0}</div>
          <div class="bg-stash-dark p-4 rounded">Posts: ${postsCount || 0}</div>
          <div class="bg-stash-dark p-4 rounded">Views: ${totalViews}</div>
          <div class="bg-stash-dark p-4 rounded">Revenue: $${totalEarnings.toFixed(5)}</div>
        </div>
      </div>
      <div class="tab-pane hidden" data-pane="users">
        <h3 class="text-xl font-bold mb-4">Manage Users</h3>
        <div id="admin-users-list" class="space-y-2"></div>
      </div>
      <div class="tab-pane hidden" data-pane="posts">
        <h3 class="text-xl font-bold mb-4">Manage Posts</h3>
        <div id="admin-posts-list" class="space-y-2"></div>
      </div>
      <div class="tab-pane hidden" data-pane="trends">
        <h3 class="text-xl font-bold mb-4">Trends</h3>
        <form id="add-trend-form" class="flex gap-2 mb-4">
          <input type="text" id="new-hashtag" placeholder="New hashtag (without #)" class="flex-1 bg-black border border-stash rounded-lg p-2">
          <button type="submit" class="bg-stash-blue text-white px-4 py-2 rounded-lg">Add</button>
        </form>
        <div id="admin-trends-list" class="space-y-2"></div>
      </div>
      <div class="tab-pane hidden" data-pane="ads">
        <h3 class="text-xl font-bold mb-4">Ads</h3>
        <button onclick="showAddAdForm()" class="bg-stash-blue text-white px-4 py-2 rounded-lg mb-4">Add New Ad</button>
        <div id="admin-ads-list" class="space-y-2"></div>
      </div>
      <div class="tab-pane hidden" data-pane="analytics">
        <canvas id="admin-chart" width="400" height="200"></canvas>
      </div>
    `;
    document.getElementById('admin-panes').innerHTML = panes;

    loadAdminUsers();
    loadAdminPosts();
    loadAdminTrends();
    loadAdminAds();
    initAdminChart();

    document.querySelectorAll('.admin-tab').forEach(btn => {
      btn.removeEventListener('click', adminTabHandler);
      btn.addEventListener('click', adminTabHandler);
    });
  }

  function adminTabHandler(e) {
    const btn = e.currentTarget;
    document.querySelectorAll('.admin-tab').forEach(b => {
      b.classList.remove('active', 'text-stash-blue', 'border-b-2', 'border-stash-blue');
      b.classList.add('text-gray-500');
    });
    btn.classList.add('active', 'text-stash-blue', 'border-b-2', 'border-stash-blue');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
    document.querySelector(`.tab-pane[data-pane="${btn.dataset.tab}"]`).classList.remove('hidden');
  }

  async function loadAdminUsers() {
    const { data: users } = await _supabase.from('profiles').select('id, username, display_name, is_admin').order('created_at');
    const list = document.getElementById('admin-users-list');
    if (!list) return;
    list.innerHTML = (users || []).map(u => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <div>
          <span class="font-bold">${escapeHTML(u.display_name || u.username)}</span> @${escapeHTML(u.username)}
          ${u.is_admin ? '' : ''}
        </div>
        <div>
          <button onclick="toggleAdmin('${u.id}', ${!u.is_admin})" class="bg-stash-blue text-white px-3 py-1 rounded text-sm mr-2">${u.is_admin ? 'Remove admin' : 'Make admin'}</button>
          <button onclick="deleteUser('${u.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
        </div>
      </div>
    `).join('');
  }

  window.toggleAdmin = async (userId, makeAdmin) => {
    await _supabase.from('profiles').update({ is_admin: makeAdmin }).eq('id', userId);
    loadAdminUsers();
  };

  window.deleteUser = async (userId) => {
    if (!confirm('Delete this user? All their posts, likes, etc. will be deleted.')) return;
    await _supabase.from('profiles').delete().eq('id', userId);
    loadAdminUsers();
  };

  async function loadAdminPosts() {
    const { data: posts } = await _supabase
      .from('posts')
      .select('*, profiles(username)')
      .order('created_at', { ascending: false });
    const list = document.getElementById('admin-posts-list');
    if (!list) return;
    list.innerHTML = (posts || []).map(p => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <div>
          <span class="font-bold">@${escapeHTML(p.profiles?.username)}</span>: ${escapeHTML(p.content?.substring(0,50))}...
          <span class="text-gray-500 text-sm">${timeAgo(p.created_at)}</span>
        </div>
        <button onclick="deletePostAdmin('${p.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
      </div>
    `).join('');
  }

  window.deletePostAdmin = async (postId) => {
    if (!confirm('Delete this post?')) return;
    await _supabase.from('posts').delete().eq('id', postId);
    loadAdminPosts();
    loadHomeFeed(true);
  };

  async function loadAdminTrends() {
    const { data } = await _supabase.from('trends').select('*').order('post_count', { ascending: false });
    const list = document.getElementById('admin-trends-list');
    if (!list) return;
    list.innerHTML = (data || []).map(t => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <span>#${t.hashtag} (${t.post_count} posts)</span>
        <button onclick="deleteTrend('${t.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
      </div>
    `).join('');
  }

  document.getElementById('add-trend-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const hashtag = document.getElementById('new-hashtag').value.trim();
    if (!hashtag) return;
    await _supabase.from('trends').insert({ hashtag, post_count: 1 });
    document.getElementById('new-hashtag').value = '';
    loadAdminTrends();
  });

  window.deleteTrend = async (trendId) => {
    await _supabase.from('trends').delete().eq('id', trendId);
    loadAdminTrends();
  };

  async function loadAdminAds() {
    const { data } = await _supabase.from('ads').select('*').order('created_at');
    const list = document.getElementById('admin-ads-list');
    if (!list) return;
    list.innerHTML = (data || []).map(ad => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <div class="flex items-center gap-3">
          <img src="${escapeHTML(ad.image_url)}" class="w-12 h-12 object-cover rounded">
          <span>${escapeHTML(ad.promoted_text)}</span>
        </div>
        <div>
          <button onclick="editAd('${ad.id}')" class="bg-stash-blue text-white px-3 py-1 rounded text-sm mr-2">Edit</button>
          <button onclick="deleteAd('${ad.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
        </div>
      </div>
    `).join('');
  }

  window.showAddAdForm = () => {
    openAdModal(null, { image_url: '', link_url: '', promoted_text: 'Promoted', active: true });
  };

  window.editAd = async (adId) => {
    const { data } = await _supabase.from('ads').select('*').eq('id', adId).single();
    if (data) openAdModal(adId, data);
  };

  function openAdModal(id, ad) {
    const existing = document.querySelector('.ad-modal-instance');
    if (existing) existing.remove();

    const modal = document.createElement('div');
    modal.className = 'ad-modal-instance fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
      <div class="bg-black border border-stash rounded-2xl w-full max-w-md p-6">
        <h2 class="text-2xl font-bold mb-4">${id ? 'Edit Ad' : 'New Ad'}</h2>
        <form id="ad-form">
          <input type="hidden" id="ad-id" value="${id || ''}">
          <div class="space-y-3">
            <input type="url" id="ad-image" placeholder="Image URL" value="${escapeHTML(ad.image_url)}" class="w-full bg-black border border-stash rounded-lg p-3" required>
            <input type="url" id="ad-link" placeholder="Link URL" value="${escapeHTML(ad.link_url || '')}" class="w-full bg-black border border-stash rounded-lg p-3">
            <input type="text" id="ad-promoted" placeholder="Promoted text" value="${escapeHTML(ad.promoted_text)}" class="w-full bg-black border border-stash rounded-lg p-3">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="ad-active" ${ad.active ? 'checked' : ''} class="w-4 h-4">
              <label>Active</label>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="bg-stash-blue text-white px-4 py-2 rounded-lg flex-1">Save</button>
              <button type="button" onclick="this.closest('.ad-modal-instance').remove()" class="bg-gray-700 text-white px-4 py-2 rounded-lg">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('ad-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const image_url = document.getElementById('ad-image').value.trim();
      const link_url = document.getElementById('ad-link').value.trim() || null;
      const promoted_text = document.getElementById('ad-promoted').value.trim() || 'Promoted';
      const active = document.getElementById('ad-active').checked;
      const id = document.getElementById('ad-id').value;
      if (!image_url) { alert('Image URL required'); return; }
      const adData = { image_url, link_url, promoted_text, active };
      if (id) {
        await _supabase.from('ads').update(adData).eq('id', id);
      } else {
        await _supabase.from('ads').insert([adData]);
      }
      modal.remove();
      loadAdminAds();
    });
  }

  window.deleteAd = async (adId) => {
    if (!confirm('Delete this ad?')) return;
    await _supabase.from('ads').delete().eq('id', adId);
    loadAdminAds();
  };

  function initAdminChart() {
    const ctx = document.getElementById('admin-chart')?.getContext('2d');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
        datasets: [{ label: 'Views', data: [12,19,3,5,2,3,9], borderColor: '#1d9bf0' }]
      }
    });
  }

  // ==================== RIGHT SIDEBAR ====================
  async function loadTrends() {
    const { data } = await _supabase.from('trends').select('*').order('post_count', { ascending: false }).limit(5);
    const list = document.getElementById('trends-list');
    if (list) list.innerHTML = (data || []).map(t => `<div>#${t.hashtag} 路 ${t.post_count}</div>`).join('') || '';
  }

  async function loadWhoToFollow() {
    if (!currentUser) return;
    const { data: users } = await _supabase
      .from('profiles')
      .select('id, username, display_name, avatar_url')
      .neq('id', currentUser.id)
      .limit(3);
    const list = document.getElementById('who-to-follow');
    if (list) {
      list.innerHTML = (users || []).map(u => `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <img src="${u.avatar_url || 'https://via.placeholder.com/32'}" class="w-8 h-8 rounded-full object-cover">
            <span class="text-sm">${u.display_name || u.username}</span>
          </div>
          <button onclick="followUser('${u.id}')" class="bg-stash-blue text-white text-xs px-3 py-1 rounded-full">Follow</button>
        </div>
      `).join('');
    }
  }

  // ==================== INIT ====================
  const mainContent = document.getElementById('main-content');
  window.goToPage = goToPage;
  window.goToProfile = (id) => { currentPage = 'profile'; loadProfile(id); };
  window.followUser = followUser;

  loadTrends();
  loadWhoToFollow();
</script>

<!-- ==================== SQL SCHEMA (RUN THIS IN SUPABASE) ====================
-- Copy and run this in Supabase SQL editor before using the app

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

DROP TABLE IF EXISTS ad_impressions CASCADE;
DROP TABLE IF EXISTS ads CASCADE;

CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  username TEXT UNIQUE NOT NULL,
  display_name TEXT,
  bio TEXT,
  avatar_url TEXT,
  banner_url TEXT,
  is_admin BOOLEAN DEFAULT false,
  is_verified BOOLEAN DEFAULT false,
  is_private BOOLEAN DEFAULT false,
  followers_count INT DEFAULT 0,
  following_count INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE posts (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES posts(id) ON DELETE CASCADE,
  content TEXT,
  image_url TEXT,
  video_url TEXT,
  poll_options JSONB,
  views INT DEFAULT 0,
  likes_count INT DEFAULT 0,
  retweets_count INT DEFAULT 0,
  replies_count INT DEFAULT 0,
  bookmarks_count INT DEFAULT 0,
  is_quote BOOLEAN DEFAULT false,
  quoted_post_id UUID REFERENCES posts(id) ON DELETE SET NULL,
  monetization_approved BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, post_id)
);

CREATE TABLE retweets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, post_id)
);

CREATE TABLE bookmarks (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  post_id UUID NOT NULL REFERENCES posts(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(user_id, post_id)
);

CREATE TABLE follows (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  follower_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  following_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(follower_id, following_id)
);

CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  type TEXT NOT NULL,
  actor_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  post_id UUID REFERENCES posts(id) ON DELETE CASCADE,
  read BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE messages (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  sender_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  recipient_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  read BOOLEAN DEFAULT false,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE trends (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  hashtag TEXT UNIQUE NOT NULL,
  post_count INT DEFAULT 0,
  last_used TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE ads (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  image_url TEXT NOT NULL,
  link_url TEXT,
  promoted_text TEXT DEFAULT 'Promoted',
  active BOOLEAN DEFAULT true,
  budget DECIMAL(10,2),
  spent DECIMAL(10,2) DEFAULT 0,
  impressions INT DEFAULT 0,
  clicks INT DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE ad_impressions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  ad_id UUID REFERENCES ads(id) ON DELETE CASCADE,
  post_id UUID REFERENCES posts(id) ON DELETE CASCADE,
  user_id UUID REFERENCES profiles(id) ON DELETE SET NULL,
  revenue DECIMAL(10,8) DEFAULT 0.0001,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE user_earnings (
  user_id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
  total_earned DECIMAL(10,8) DEFAULT 0,
  last_updated TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE user_settings (
  user_id UUID PRIMARY KEY REFERENCES profiles(id) ON DELETE CASCADE,
  email_notifications BOOLEAN DEFAULT true,
  dark_mode BOOLEAN DEFAULT true,
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE OR REPLACE FUNCTION increment_post_view(post_id UUID)
RETURNS INTEGER AS $$
DECLARE
  new_views INTEGER;
BEGIN
  UPDATE posts SET views = views + 1 WHERE id = post_id RETURNING views INTO new_views;
  IF new_views >= 500 THEN
    UPDATE posts SET monetization_approved = true WHERE id = post_id AND monetization_approved = false;
  END IF;
  RETURN new_views;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION increment_follow_counts(follower UUID, following UUID)
RETURNS void AS $$
BEGIN
  UPDATE profiles SET following_count = following_count + 1 WHERE id = follower;
  UPDATE profiles SET followers_count = followers_count + 1 WHERE id = following;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username, display_name)
  VALUES (
    NEW.id,
    COALESCE(NEW.raw_user_meta_data->>'username', split_part(NEW.email, '@', 1)),
    COALESCE(NEW.raw_user_meta_data->>'username', split_part(NEW.email, '@', 1))
  );
  INSERT INTO public.user_settings (user_id) VALUES (NEW.id);
  INSERT INTO public.user_earnings (user_id) VALUES (NEW.id);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
-->
</body>
</html>
