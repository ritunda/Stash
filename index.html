<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>Stash Â· social</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background-color: black; color: #e7e9ea; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .border-stash { border-color: #2f3336; }
    .hover-stash:hover { background-color: #181818; }
    .text-stash-blue { color: #1d9bf0; }
    .bg-stash-blue { background-color: #1d9bf0; }
    .bg-stash-dark { background-color: #16181c; }
    .skeleton { background: linear-gradient(90deg, #2f3336 25%, #3a3f44 50%, #2f3336 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    .compose-box { cursor: pointer; transition: background-color 0.2s; }
    .compose-box:hover { background-color: #080808; }
    .hero-banner {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
      border-bottom: 1px solid #2f3336;
      padding: 2rem 1rem;
      text-align: center;
    }
    .hero-svg { width: 80px; height: auto; margin: 0 auto 1rem; }
    .hero-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.5rem; }
    .hero-subtitle { font-size: 1.1rem; color: #9ca3af; max-width: 600px; margin: 0 auto 1.5rem; }
    .hero-button { background-color: #1d9bf0; color: white; padding: 0.75rem 2rem; border-radius: 9999px; font-weight: bold; display: inline-block; transition: background-color 0.2s; }
    .hero-button:hover { background-color: #1a8cd8; }
    .avatar-feed { width: 48px; height: 48px; object-fit: cover; border-radius: 9999px; }
    .avatar-profile { width: 96px; height: 96px; object-fit: cover; border-radius: 9999px; border: 4px solid black; }
    .banner-profile { width: 100%; height: 150px; object-fit: cover; }
    .admin-crown { color: #fbbf24; font-size: 1.5rem; margin-left: 0.5rem; cursor: pointer; }
    .hashtag, .mention { color: #1d9bf0; cursor: pointer; }
    .hashtag:hover, .mention:hover { text-decoration: underline; }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: black; border-top: 1px solid #2f3336; display: flex; justify-content: space-around; padding: 0.5rem 0; z-index: 10; }
    .bottom-nav a { color: #6b7280; font-size: 1.5rem; }
    .bottom-nav a.active { color: #1d9bf0; }
    .main-with-nav { padding-bottom: 5rem; }
    @media (max-width: 1024px) {
      .modal-content { width: 100%; height: 100%; border-radius: 0; }
    }
    #new-posts-banner {
      transition: transform 0.3s ease, opacity 0.3s ease;
      transform: translateY(-100%);
      opacity: 0;
      position: fixed;
      top: 60px;
      left: 50%;
      transform: translateX(-50%) translateY(-100%);
      z-index: 30;
    }
    #new-posts-banner.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body class="bg-black text-[#e7e9ea]">

<!-- Top Header -->
<div class="sticky top-0 bg-black border-b border-stash z-20 p-3 flex justify-between items-center">
  <svg width="100" height="40" viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg" class="h-8 w-auto" onclick="goToPage('home')">
    <defs>
      <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%" stop-color="#10B981" />
        <stop offset="100%" stop-color="#3B82F6" />
      </linearGradient>
    </defs>
    <path d="M25 100 C 30 40, 80 30, 110 55 C 140 80, 120 130, 70 130 C 30 130, 20 90, 40 70 C 55 55, 80 60, 90 75" stroke="url(#headerGrad)" stroke-width="14" fill="none" stroke-linecap="round" stroke-linejoin="round" />
    <polygon points="145,65 165,40 180,65" fill="#10B981" />
    <text x="190" y="95" font-family="Inter, Arial, Helvetica, sans-serif" font-size="70" font-weight="500" fill="#e7e9ea">stash</text>
  </svg>
  <div id="header-buttons" class="flex items-center gap-3">
    <i id="admin-crown-header" class="fa-solid fa-crown admin-crown hidden" onclick="openAdminDashboard()"></i>
    <button id="logout-btn-header" class="text-gray-400 hover:text-white hidden" onclick="logout()"><i class="fa-solid fa-sign-out-alt"></i></button>
    <button id="login-btn-header" class="bg-stash-blue text-white px-4 py-1 rounded-full text-sm" onclick="showAuthModal()">Log in</button>
  </div>
</div>

<!-- New Posts Banner -->
<div id="new-posts-banner" class="bg-stash-blue text-white py-2 px-4 rounded-full shadow-lg cursor-pointer" onclick="loadHomeFeed(true); this.classList.remove('show')">
  <i class="fa-solid fa-arrow-up mr-2"></i>New posts available
</div>

<!-- Main Content -->
<main id="main-content" class="main-with-nav p-0"></main>

<!-- Bottom Navigation -->
<div class="bottom-nav">
  <a href="#" class="nav-link" data-page="home"><i class="fa-solid fa-house"></i></a>
  <a href="#" class="nav-link" data-page="explore"><i class="fa-solid fa-hashtag"></i></a>
  <a href="#" class="nav-link" data-page="notifications"><i class="fa-regular fa-bell"></i></a>
  <a href="#" class="nav-link" data-page="profile"><i class="fa-regular fa-user"></i></a>
</div>

<!-- Compose Modal -->
<div id="compose-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-0 lg:p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-lg p-6 modal-content">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold">Compose post</h2>
      <button onclick="closeModal('compose-modal')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
    </div>
    <form id="compose-form">
      <textarea id="compose-content" rows="4" placeholder="What's happening?" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required></textarea>
      <input type="url" id="compose-image" placeholder="Image URL (optional)" class="w-full bg-black border border-stash rounded-lg p-3 mt-2 text-white">
      <input type="url" id="compose-video" placeholder="Video URL (YouTube/Vimeo)" class="w-full bg-black border border-stash rounded-lg p-3 mt-2 text-white">
      <div class="flex items-center gap-2 mt-3">
        <input type="checkbox" id="compose-poll" class="w-4 h-4">
        <label for="compose-poll" class="text-sm">Add poll (Home/Draw/Away)</label>
      </div>
      <button type="submit" class="bg-stash-blue text-white rounded-full py-3 px-6 font-bold mt-4 w-full">Post</button>
    </form>
  </div>
</div>

<!-- Edit Post Modal -->
<div id="edit-post-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-0 lg:p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-lg p-6 modal-content">
    <h2 class="text-2xl font-bold mb-4">Edit post</h2>
    <form id="edit-post-form">
      <input type="hidden" id="edit-post-id">
      <textarea id="edit-post-content" rows="4" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required></textarea>
      <input type="url" id="edit-post-image" placeholder="Image URL" class="w-full bg-black border border-stash rounded-lg p-3 mt-2 text-white">
      <button type="submit" class="bg-stash-blue text-white rounded-full py-2 px-4 font-bold mt-3">Update</button>
    </form>
  </div>
</div>

<!-- Reply Modal -->
<div id="reply-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-0 lg:p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-lg p-6 modal-content">
    <h2 class="text-2xl font-bold mb-4">Reply</h2>
    <form id="reply-form">
      <input type="hidden" id="reply-post-id">
      <textarea id="reply-content" rows="3" placeholder="Post your reply" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required></textarea>
      <button type="submit" class="bg-stash-blue text-white rounded-full py-2 px-4 font-bold mt-3">Reply</button>
    </form>
  </div>
</div>

<!-- Withdraw Modal -->
<div id="withdraw-modal" class="fixed inset-0 modal-overlay hidden items-center justify-center z-50 p-0 lg:p-4">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-lg p-6 modal-content">
    <h2 class="text-2xl font-bold mb-4">Withdraw Earnings</h2>
    <form id="withdraw-form">
      <p class="mb-4 text-gray-400">Your balance: <span id="withdraw-balance">$0.00</span></p>
      <input type="number" id="withdraw-amount" placeholder="Amount" step="0.01" min="0.01" class="w-full bg-black border border-stash rounded-lg p-3 text-white mb-3" required>
      <select id="withdraw-method" class="w-full bg-black border border-stash rounded-lg p-3 text-white mb-3" required>
        <option value="">Select method</option>
        <option value="paypal">PayPal</option>
        <option value="crypto">Cryptocurrency</option>
      </select>
      <input type="text" id="withdraw-address" placeholder="PayPal email or crypto address" class="w-full bg-black border border-stash rounded-lg p-3 text-white mb-3" required>
      <button type="submit" class="bg-stash-blue text-white rounded-full py-3 px-6 font-bold w-full">Request Withdrawal</button>
    </form>
  </div>
</div>

<!-- Admin Dashboard Modal -->
<div id="admin-modal" class="fixed inset-0 modal-overlay hidden z-50 overflow-y-auto p-0">
  <div class="bg-black min-h-screen p-4 w-full">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-bold">Admin</h1>
      <button onclick="closeModal('admin-modal')" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark text-2xl"></i></button>
    </div>
    <div class="border-b border-stash mb-4 overflow-x-auto">
      <nav class="flex gap-4">
        <button class="admin-tab active text-stash-blue border-b-2 border-stash-blue pb-1" data-tab="dashboard">Dashboard</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-1" data-tab="users">Users</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-1" data-tab="posts">Posts</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-1" data-tab="trends">Trends</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-1" data-tab="ads">Ads</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-1" data-tab="withdrawals">Withdrawals</button>
        <button class="admin-tab text-gray-500 hover:text-white pb-1" data-tab="analytics">Analytics</button>
      </nav>
    </div>
    <div id="admin-panes"></div>
  </div>
</div>

<!-- Login/Signup Modal -->
<div id="auth-modal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4 hidden">
  <div class="bg-black border border-stash rounded-2xl w-full max-w-md p-6">
    <h2 class="text-2xl font-bold mb-4 text-center">Welcome to Stash</h2>
    <form id="login-form" class="space-y-3">
      <input type="email" id="login-email" placeholder="Email" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <input type="password" id="login-password" placeholder="Password" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <button type="submit" class="bg-stash-blue text-white rounded-full py-3 px-6 font-bold w-full">Log in</button>
    </form>
    <p class="text-center text-gray-500 my-2">or</p>
    <form id="signup-form" class="space-y-3">
      <input type="email" id="signup-email" placeholder="Email" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <input type="password" id="signup-password" placeholder="Password" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <input type="text" id="signup-username" placeholder="Username" class="w-full bg-black border border-stash rounded-lg p-3 text-white" required>
      <button type="submit" class="bg-green-600 text-white rounded-full py-3 px-6 font-bold w-full">Create account</button>
    </form>
  </div>
</div>

<script>
  // ==================== CONFIG ====================
  const SUPABASE_URL = 'https://vcopwxjcjraddqwxmxkb.supabase.co';
  const SUPABASE_ANON_KEY = 'sb_publishable_9b2BZuqv8hms1kXt9hBXnQ_GBCzLmSn'; // REPLACE
  const { createClient } = supabase;
  const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ==================== STATE ====================
  let currentUser = null;
  let currentProfile = null;
  let currentPage = 'home';
  let posts = [];
  let trends = [];
  let pageOffset = 0;
  const POSTS_PER_PAGE = 10;
  let loading = false;
  let hasMore = true;
  let viewedPosts = new Set();
  let notificationsInterval = null;
  let lastPostTimestamp = null;
  let pollInterval = null;
  let scrollHandler = null;

  // ==================== DOM HELPERS ====================
  function escapeHTML(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"]/g, function(m) {
      if (m === '&') return '&amp;';
      if (m === '<') return '&lt;';
      if (m === '>') return '&gt;';
      if (m === '"') return '&quot;';
      return m;
    });
  }

  function timeAgo(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    if (seconds < 60) return 'just now';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h`;
    const days = Math.floor(hours / 24);
    return `${days}d`;
  }

  function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
  }

  function showAuthModal() {
    document.getElementById('auth-modal').classList.remove('hidden');
  }

  function validateVideoUrl(url) {
    if (!url) return null;
    const ytRegex = /^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]+)/;
    const vimeoRegex = /^(https?:\/\/)?(www\.)?(vimeo\.com\/)([0-9]+)/;
    if (ytRegex.test(url)) {
      const match = url.match(/(?:v=|\/)([a-zA-Z0-9_-]+)/);
      return `https://www.youtube.com/embed/${match[1]}`;
    } else if (vimeoRegex.test(url)) {
      const match = url.match(/([0-9]+)$/);
      return `https://player.vimeo.com/video/${match[1]}`;
    }
    return null;
  }

  function linkify(text) {
    if (!text) return '';
    let escaped = escapeHTML(text);
    escaped = escaped.replace(/@([a-zA-Z0-9_]+)/g, '<span class="mention" onclick="goToProfileByUsername(\'$1\')">@$1</span>');
    escaped = escaped.replace(/#([a-zA-Z0-9_]+)/g, '<span class="hashtag" onclick="searchHashtag(\'$1\')">#$1</span>');
    return escaped;
  }

  // ==================== AUTH ====================
  async function fetchCurrentProfile() {
    if (!currentUser) { currentProfile = null; return; }
    const { data, error } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    if (!error) currentProfile = data;
  }

  async function updateAuthUI(user) {
    await fetchCurrentProfile();
    const authModal = document.getElementById('auth-modal');
    const loginBtn = document.getElementById('login-btn-header');
    const logoutBtn = document.getElementById('logout-btn-header');
    const crown = document.getElementById('admin-crown-header');

    if (user) {
      authModal.classList.add('hidden');
      loginBtn.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      if (currentProfile?.is_admin) crown.classList.remove('hidden');
      else crown.classList.add('hidden');
      startPolling();
    } else {
      loginBtn.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      crown.classList.add('hidden');
      if (notificationsInterval) clearInterval(notificationsInterval);
      if (pollInterval) clearInterval(pollInterval);
    }
    loadPage(currentPage);
  }

  _supabase.auth.getSession().then(({ data: { session } }) => {
    currentUser = session?.user ?? null;
    updateAuthUI(currentUser);
  });
  _supabase.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user ?? null;
    updateAuthUI(currentUser);
  });

  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    const { error } = await _supabase.auth.signInWithPassword({ email, password });
    if (error) alert('Login error: ' + error.message);
  });

  document.getElementById('signup-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('signup-email').value;
    const password = document.getElementById('signup-password').value;
    const username = document.getElementById('signup-username').value;
    const { error } = await _supabase.auth.signUp({
      email,
      password,
      options: { data: { username } }
    });
    if (error) alert('Signup error: ' + error.message);
    else alert('Check your email for confirmation!');
  });

  window.logout = async () => {
    await _supabase.auth.signOut();
    goToPage('home');
  };

  // ==================== ROUTING ====================
  document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const page = link.dataset.page;
      goToPage(page);
    });
  });

  function goToPage(page) {
    currentPage = page;
    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
    document.querySelector(`.nav-link[data-page="${page}"]`)?.classList.add('active');
    loadPage(page);
  }

  async function loadPage(page) {
    mainContent.innerHTML = getSkeletonForPage(page);
    if (page === 'home') await loadHomeFeed(true);
    else if (page === 'explore') await loadExplore();
    else if (page === 'notifications') await loadNotifications();
    else if (page === 'profile') await loadProfile(currentUser?.id);
  }

  function getSkeletonForPage(page) {
    if (page === 'home') {
      let html = '';
      for (let i = 0; i < 5; i++) {
        html += `
          <div class="p-4 border-b border-stash">
            <div class="flex gap-3">
              <div class="skeleton w-12 h-12 rounded-full"></div>
              <div class="flex-1 space-y-2">
                <div class="skeleton h-4 w-24"></div>
                <div class="skeleton h-4 w-full"></div>
                <div class="skeleton h-4 w-2/3"></div>
              </div>
            </div>
          </div>
        `;
      }
      return html;
    }
    return '<div class="p-4 text-center">Loading...</div>';
  }

  // ==================== POLLING FOR NEW POSTS ====================
  function startPolling() {
    if (pollInterval) clearInterval(pollInterval);
    pollInterval = setInterval(checkForNewPosts, 30000);
  }
  async function checkForNewPosts() {
    if (!lastPostTimestamp) return;
    const { data, error } = await _supabase
      .from('posts')
      .select('created_at')
      .order('created_at', { ascending: false })
      .limit(1);
    if (error || !data.length) return;
    const latest = new Date(data[0].created_at).getTime();
    if (latest > lastPostTimestamp) {
      document.getElementById('new-posts-banner').classList.add('show');
    }
  }

  // ==================== HOME FEED ====================
  async function loadHomeFeed(reset = true) {
    if (reset) { pageOffset = 0; hasMore = true; }
    if (!hasMore || loading) return;
    loading = true;

    const { data: fetchedPosts, error } = await _supabase
      .from('posts')
      .select('*')
      .is('parent_id', null)
      .order('created_at', { ascending: false })
      .range(pageOffset, pageOffset + POSTS_PER_PAGE - 1);
    if (error) { console.error(error); loading = false; return; }

    if (fetchedPosts.length > 0) {
      const latest = new Date(fetchedPosts[0].created_at).getTime();
      if (!lastPostTimestamp) lastPostTimestamp = latest;
      else if (latest > lastPostTimestamp) lastPostTimestamp = latest;
    }

    if (reset) posts = fetchedPosts;
    else posts = [...posts, ...fetchedPosts];
    pageOffset += fetchedPosts.length;
    hasMore = fetchedPosts.length === POSTS_PER_PAGE;

    await enrichPosts(posts.slice(reset ? 0 : posts.length - fetchedPosts.length));
    renderHomeFeed(reset);
    loading = false;
  }

  async function enrichPosts(postList) {
    const userIds = [...new Set(postList.map(p => p.user_id))];
    const { data: profiles } = await _supabase.from('profiles').select('id, username, display_name, avatar_url, is_verified').in('id', userIds);
    const profileMap = Object.fromEntries((profiles || []).map(p => [p.id, p]));

    for (let post of postList) {
      post.profile = profileMap[post.user_id] || { username: 'anonymous', display_name: 'Anonymous', avatar_url: null };
      const { count: likes } = await _supabase.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', post.id);
      post.likes_count = likes || 0;
      const { count: retweets } = await _supabase.from('retweets').select('*', { count: 'exact', head: true }).eq('post_id', post.id);
      post.retweets_count = retweets || 0;
      const { count: replies } = await _supabase.from('posts').select('*', { count: 'exact', head: true }).eq('parent_id', post.id);
      post.replies_count = replies || 0;
      if (currentUser) {
        const { data: userLike } = await _supabase.from('likes').select('id').eq('post_id', post.id).eq('user_id', currentUser.id).maybeSingle();
        post.liked_by_me = !!userLike;
        const { data: userRetweet } = await _supabase.from('retweets').select('id').eq('post_id', post.id).eq('user_id', currentUser.id).maybeSingle();
        post.retweeted_by_me = !!userRetweet;
        const { data: userBookmark } = await _supabase.from('bookmarks').select('id').eq('post_id', post.id).eq('user_id', currentUser.id).maybeSingle();
        post.bookmarked_by_me = !!userBookmark;
      }
      if (!viewedPosts.has(post.id)) {
        viewedPosts.add(post.id);
        await _supabase.rpc('increment_post_view', { post_id: post.id });
        // Simulate ad impression (10% chance)
        if (Math.random() < 0.1 && currentUser && post.user_id !== currentUser.id) {
          const { data: ads } = await _supabase.from('ads').select('id').eq('active', true);
          if (ads && ads.length > 0) {
            const ad = ads[Math.floor(Math.random() * ads.length)];
            await _supabase.from('ad_impressions').insert({
              ad_id: ad.id,
              post_id: post.id,
              user_id: currentUser.id,
              revenue: 0.0001
            });
            await _supabase.rpc('increment_user_earnings', { p_user_id: post.user_id, amount: 0.0001 });
          }
        }
      }
    }
  }

  function renderHomeFeed(reset) {
    const heroHtml = !currentUser ? `
      <div class="hero-banner">
        <svg class="hero-svg" width="80" height="80" viewBox="0 0 500 200" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="heroGrad" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="#10B981" />
              <stop offset="100%" stop-color="#3B82F6" />
            </linearGradient>
          </defs>
          <path d="M25 100 C 30 40, 80 30, 110 55 C 140 80, 120 130, 70 130 C 30 130, 20 90, 40 70 C 55 55, 80 60, 90 75" stroke="url(#heroGrad)" stroke-width="14" fill="none" stroke-linecap="round" stroke-linejoin="round" />
          <polygon points="145,65 165,40 180,65" fill="#10B981" />
          <text x="190" y="95" font-family="Inter, Arial, Helvetica, sans-serif" font-size="70" font-weight="500" fill="#e7e9ea">stash</text>
        </svg>
        <h1 class="hero-title">Your Voice, Your Earnings</h1>
        <p class="hero-subtitle">Join thousands earning from their content. Get paid for ad views. Connect, share, and grow.</p>
        <div class="flex justify-center gap-2 text-sm text-gray-400 mb-4">
          <span>âœ… 10k+ active users</span>
          <span>ðŸ’° $50k+ paid out</span>
        </div>
        <a href="#" onclick="showAuthModal(); return false;" class="hero-button">Join Stash Today</a>
      </div>
    ` : '';

    const composeHtml = currentUser ? `
      <div class="p-4 border-b border-stash compose-box" onclick="document.getElementById('compose-modal').classList.remove('hidden')">
        <div class="flex gap-3">
          <img src="${currentProfile?.avatar_url || 'https://via.placeholder.com/48'}" class="avatar-feed">
          <div class="flex-1">
            <div class="bg-black border border-stash rounded-2xl p-3 text-gray-500">What's happening?</div>
            <div class="flex gap-4 mt-2 text-gray-500">
              <i class="fa-regular fa-image"></i>
              <i class="fa-regular fa-video"></i>
              <i class="fa-regular fa-chart-bar"></i>
            </div>
          </div>
        </div>
      </div>
    ` : '';

    let feedHtml = '';
    posts.forEach(post => { feedHtml += renderPost(post); });
    const fullHtml = heroHtml + composeHtml + feedHtml;

    if (reset) mainContent.innerHTML = fullHtml;
    else mainContent.insertAdjacentHTML('beforeend', feedHtml);

    attachPostListeners();
    setupInfiniteScroll();
  }

  function setupInfiniteScroll() {
    if (scrollHandler) window.removeEventListener('scroll', scrollHandler);
    scrollHandler = () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
        loadHomeFeed(false);
      }
    };
    window.addEventListener('scroll', scrollHandler);
  }

  function renderPost(post) {
    const escapedName = escapeHTML(post.profile?.display_name || 'User');
    const escapedUsername = escapeHTML(post.profile?.username);
    const escapedAvatar = escapeHTML(post.profile?.avatar_url || 'https://via.placeholder.com/48');
    const linkedContent = linkify(post.content || '');
    const likeIcon = post.liked_by_me ? 'fa-solid' : 'fa-regular';
    const retweetIcon = post.retweeted_by_me ? 'fa-solid' : 'fa-regular';
    const bookmarkIcon = post.bookmarked_by_me ? 'fa-solid' : 'fa-regular';
    const canEdit = currentUser && (currentUser.id === post.user_id || currentProfile?.is_admin);
    const editButton = canEdit ? `<button class="edit-post-btn text-gray-500 hover:text-stash-blue ml-2" data-post-id="${post.id}"><i class="fa-regular fa-pen-to-square"></i></button>` : '';

    let pollHtml = '';
    if (post.poll_options) {
      const options = JSON.parse(post.poll_options);
      pollHtml = '<div class="mt-2 space-y-1">' + options.map(o => `<div class="bg-stash-dark p-2 rounded">${o}</div>`).join('') + '</div>';
    }

    return `
      <div class="p-4 border-b border-stash hover:bg-[#080808] transition" data-post-id="${post.id}">
        <div class="flex gap-3">
          <img src="${escapedAvatar}" class="avatar-feed cursor-pointer" onclick="goToProfile('${post.user_id}')">
          <div class="flex-1">
            <div class="flex items-center gap-1 flex-wrap">
              <span class="font-bold">${escapedName}</span>
              ${post.profile?.is_verified ? '<i class="fa-solid fa-circle-check text-stash-blue text-sm"></i>' : ''}
              <span class="text-gray-500 text-sm">@${escapedUsername} Â· ${timeAgo(post.created_at)}</span>
              ${editButton}
            </div>
            <p class="mt-1">${linkedContent}</p>
            ${post.image_url ? `<img src="${escapeHTML(post.image_url)}" class="rounded-xl mt-2 max-h-96 object-cover">` : ''}
            ${post.video_url ? `<div class="mt-2"><iframe src="${escapeHTML(post.video_url)}" class="w-full h-64 rounded-xl" frameborder="0" allowfullscreen></iframe></div>` : ''}
            ${pollHtml}
            <div class="flex justify-between mt-3 text-gray-500 max-w-md">
              <button class="reply-btn flex items-center gap-1 hover:text-stash-blue" data-post-id="${post.id}"><i class="fa-regular fa-comment"></i> ${post.replies_count}</button>
              <button class="retweet-btn flex items-center gap-1 hover:text-green-500" data-post-id="${post.id}"><i class="${retweetIcon} fa-retweet"></i> ${post.retweets_count}</button>
              <button class="like-btn flex items-center gap-1 hover:text-red-500" data-post-id="${post.id}"><i class="${likeIcon} fa-heart"></i> ${post.likes_count}</button>
              <button class="bookmark-btn flex items-center gap-1 hover:text-stash-blue" data-post-id="${post.id}"><i class="${bookmarkIcon} fa-bookmark"></i></button>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function attachPostListeners() {
    document.querySelectorAll('.like-btn').forEach(btn => btn.addEventListener('click', handleLike));
    document.querySelectorAll('.retweet-btn').forEach(btn => btn.addEventListener('click', handleRetweet));
    document.querySelectorAll('.bookmark-btn').forEach(btn => btn.addEventListener('click', handleBookmark));
    document.querySelectorAll('.reply-btn').forEach(btn => btn.addEventListener('click', openReplyModal));
    document.querySelectorAll('.edit-post-btn').forEach(btn => btn.addEventListener('click', openEditModal));
  }

  // ==================== INTERACTIONS ====================
  async function handleLike(e) {
    if (!currentUser) { showAuthModal(); return; }
    const btn = e.currentTarget;
    const postId = btn.dataset.postId;
    const post = posts.find(p => p.id === postId);
    const wasLiked = btn.querySelector('i').classList.contains('fa-solid');
    const countSpan = btn.querySelector('span');
    if (wasLiked) {
      btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
      countSpan.textContent = parseInt(countSpan.textContent) - 1;
    } else {
      btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
      countSpan.textContent = parseInt(countSpan.textContent) + 1;
    }
    let error;
    if (wasLiked) {
      ({ error } = await _supabase.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id));
    } else {
      ({ error } = await _supabase.from('likes').insert({ user_id: currentUser.id, post_id: postId }));
      if (!error && post) createNotification(post.user_id, 'like', postId);
    }
    if (error) {
      if (wasLiked) {
        btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
        countSpan.textContent = parseInt(countSpan.textContent) + 1;
      } else {
        btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
        countSpan.textContent = parseInt(countSpan.textContent) - 1;
      }
      alert('Error');
    }
  }

  async function handleRetweet(e) {
    if (!currentUser) { showAuthModal(); return; }
    const btn = e.currentTarget;
    const postId = btn.dataset.postId;
    const post = posts.find(p => p.id === postId);
    const wasRetweeted = btn.querySelector('i').classList.contains('fa-solid');
    const countSpan = btn.querySelector('span');
    if (wasRetweeted) {
      btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
      countSpan.textContent = parseInt(countSpan.textContent) - 1;
      await _supabase.from('retweets').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
      countSpan.textContent = parseInt(countSpan.textContent) + 1;
      await _supabase.from('retweets').insert({ user_id: currentUser.id, post_id: postId });
      if (post) createNotification(post.user_id, 'retweet', postId);
    }
  }

  async function handleBookmark(e) {
    if (!currentUser) { showAuthModal(); return; }
    const btn = e.currentTarget;
    const postId = btn.dataset.postId;
    const wasBookmarked = btn.querySelector('i').classList.contains('fa-solid');
    if (wasBookmarked) {
      btn.querySelector('i').classList.replace('fa-solid', 'fa-regular');
      await _supabase.from('bookmarks').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      btn.querySelector('i').classList.replace('fa-regular', 'fa-solid');
      await _supabase.from('bookmarks').insert({ user_id: currentUser.id, post_id: postId });
    }
  }

  function openReplyModal(e) {
    const postId = e.currentTarget.dataset.postId;
    document.getElementById('reply-post-id').value = postId;
    document.getElementById('reply-modal').classList.remove('hidden');
  }

  document.getElementById('reply-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) { showAuthModal(); return; }
    const postId = document.getElementById('reply-post-id').value;
    const content = document.getElementById('reply-content').value.trim();
    if (!content) return;
    const { error } = await _supabase.from('posts').insert({
      user_id: currentUser.id,
      parent_id: postId,
      content
    });
    if (!error) {
      closeModal('reply-modal');
      document.getElementById('reply-content').value = '';
      const post = posts.find(p => p.id === postId);
      if (post) createNotification(post.user_id, 'reply', postId);
      loadHomeFeed(true);
    } else alert('Reply failed');
  });

  async function createNotification(targetUserId, type, postId = null) {
    if (targetUserId === currentUser.id) return;
    await _supabase.from('notifications').insert({
      user_id: targetUserId,
      type,
      actor_id: currentUser.id,
      post_id: postId
    });
  }

  // ==================== EDIT POST ====================
  function openEditModal(e) {
    const postId = e.currentTarget.dataset.postId;
    const post = posts.find(p => p.id === postId);
    if (!post) return;
    document.getElementById('edit-post-id').value = post.id;
    document.getElementById('edit-post-content').value = post.content || '';
    document.getElementById('edit-post-image').value = post.image_url || '';
    document.getElementById('edit-post-modal').classList.remove('hidden');
  }

  document.getElementById('edit-post-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;
    const postId = document.getElementById('edit-post-id').value;
    const content = document.getElementById('edit-post-content').value.trim();
    const image_url = document.getElementById('edit-post-image').value.trim() || null;
    if (!content) { alert('Content cannot be empty'); return; }
    const { error } = await _supabase
      .from('posts')
      .update({ content, image_url })
      .eq('id', postId)
      .eq('user_id', currentUser.id);
    if (!error) {
      closeModal('edit-post-modal');
      loadHomeFeed(true);
    } else alert('Edit failed: ' + error.message);
  });

  // ==================== COMPOSE ====================
  document.getElementById('compose-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) { showAuthModal(); return; }
    const content = document.getElementById('compose-content').value.trim();
    const image_url = document.getElementById('compose-image').value;
    const video_url = validateVideoUrl(document.getElementById('compose-video').value);
    const isPoll = document.getElementById('compose-poll').checked;
    if (!content && !image_url && !video_url) { alert('Post cannot be empty'); return; }
    const poll_options = isPoll ? JSON.stringify(['Home', 'Draw', 'Away']) : null;
    const { error } = await _supabase.from('posts').insert({
      user_id: currentUser.id,
      content,
      image_url: image_url || null,
      video_url: video_url,
      poll_options
    });
    if (!error) {
      closeModal('compose-modal');
      document.getElementById('compose-content').value = '';
      document.getElementById('compose-image').value = '';
      document.getElementById('compose-video').value = '';
      document.getElementById('compose-poll').checked = false;
      loadHomeFeed(true);
      // Check for mentions and create notifications
      const mentions = content.match(/@([a-zA-Z0-9_]+)/g);
      if (mentions) {
        for (let m of mentions) {
          const username = m.slice(1);
          const { data: user } = await _supabase.from('profiles').select('id').eq('username', username).single();
          if (user) createNotification(user.id, 'mention', null);
        }
      }
    } else alert('Error: ' + error.message);
  });

  // ==================== NOTIFICATIONS ====================
  async function loadNotifications() {
    if (!currentUser) return;
    const { data } = await _supabase
      .from('notifications')
      .select('*, actor:actor_id(username, display_name, avatar_url), post:post_id(content)')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });
    let html = '<div class="p-4"><h2 class="text-2xl font-bold mb-4">Notifications</h2>';
    if (!data || data.length === 0) html += '<p class="text-gray-500">No notifications yet.</p>';
    else {
      data.forEach(n => {
        const actor = n.actor?.display_name || n.actor?.username || 'Someone';
        const time = timeAgo(n.created_at);
        let text = '';
        if (n.type === 'like') text = 'liked your post';
        else if (n.type === 'retweet') text = 'retweeted your post';
        else if (n.type === 'reply') text = 'replied to your post';
        else if (n.type === 'follow') text = 'followed you';
        else if (n.type === 'mention') text = 'mentioned you';
        html += `<div class="border-b border-stash py-3">${actor} ${text} Â· ${time}</div>`;
      });
    }
    html += '</div>';
    mainContent.innerHTML = html;
  }

  // ==================== EXPLORE / HASHTAG SEARCH ====================
  async function loadExplore() {
    const { data: trendsData } = await _supabase.from('trends').select('*').order('post_count', { ascending: false }).limit(10);
    trends = trendsData || [];
    let html = '<div class="p-4"><h2 class="text-2xl font-bold mb-4">Explore</h2>';
    html += '<div class="space-y-2">';
    trends.forEach(t => {
      html += `<div class="p-3 border border-stash rounded cursor-pointer" onclick="searchHashtag('${t.hashtag}')">#${t.hashtag} Â· ${t.post_count} posts</div>`;
    });
    html += '</div></div>';
    mainContent.innerHTML = html;
  }

  window.searchHashtag = async (tag) => {
    const { data } = await _supabase
      .from('posts')
      .select('*')
      .ilike('content', `%#${tag}%`)
      .is('parent_id', null)
      .order('created_at', { ascending: false });
    if (data) {
      await enrichPosts(data);
      let html = `<div class="p-4"><h2 class="text-xl font-bold mb-4">#${tag}</h2>`;
      if (data.length === 0) html += '<p>No posts found.</p>';
      else data.forEach(p => html += renderPost(p));
      html += '</div>';
      mainContent.innerHTML = html;
      attachPostListeners();
    }
  };

  // ==================== PROFILE ====================
  window.goToProfile = (userId) => loadProfile(userId);
  window.goToProfileByUsername = async (username) => {
    const { data } = await _supabase.from('profiles').select('id').eq('username', username).single();
    if (data) loadProfile(data.id);
  };

  async function loadProfile(userId) {
    if (!userId) userId = currentUser.id;
    const { data: profile } = await _supabase.from('profiles').select('*').eq('id', userId).single();
    const { data: userPosts } = await _supabase.from('posts').select('*').eq('user_id', userId).is('parent_id', null).order('created_at', { ascending: false });
    await enrichPosts(userPosts || []);
    const { data: earnings } = await _supabase.from('user_earnings').select('total_earned').eq('user_id', userId).single();
    const balance = earnings?.total_earned || 0;
    const { count: monetizedCount } = await _supabase.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId).eq('monetization_approved', true);
    const canWithdraw = monetizedCount > 0 && balance > 0;

    let html = `
      <div class="relative">
        <img src="${profile?.banner_url || 'https://via.placeholder.com/600x150'}" class="banner-profile">
        <img src="${profile?.avatar_url || 'https://via.placeholder.com/96'}" class="avatar-profile absolute -bottom-12 left-4">
        <div class="pt-16 p-4">
          <div class="flex justify-between">
            <div>
              <h2 class="text-2xl font-bold">${escapeHTML(profile?.display_name || 'User')}</h2>
              <p class="text-gray-500">@${escapeHTML(profile?.username)}</p>
            </div>
            ${userId === currentUser?.id ? '<button onclick="loadSettings()" class="bg-stash-blue text-white px-4 py-2 rounded-full">Edit profile</button>' : '<button onclick="followUser(\''+userId+'\')" class="bg-stash-blue text-white px-4 py-2 rounded-full">Follow</button>'}
          </div>
          <p class="mt-2">${escapeHTML(profile?.bio || '')}</p>
          <div class="flex gap-4 mt-2 text-gray-500">
            <span><span class="font-bold text-white">${profile?.following_count || 0}</span> Following</span>
            <span><span class="font-bold text-white">${profile?.followers_count || 0}</span> Followers</span>
          </div>
          ${canWithdraw ? `<div class="mt-4"><button onclick="openWithdrawModal(${balance})" class="bg-green-600 text-white px-4 py-2 rounded-full">Withdraw $${balance.toFixed(2)}</button></div>` : ''}
        </div>
      </div>
    `;
    userPosts?.forEach(p => html += renderPost(p));
    mainContent.innerHTML = html;
    attachPostListeners();
  }

  async function followUser(userId) {
    if (!currentUser) { showAuthModal(); return; }
    await _supabase.from('follows').insert({ follower_id: currentUser.id, following_id: userId });
    const { error } = await _supabase.rpc('increment_follow_counts', { follower: currentUser.id, following: userId });
    if (error) console.warn('RPC error, updating manually', error);
    else {
      if (currentProfile) currentProfile.following_count++;
      const followBtn = document.querySelector(`button[onclick*="followUser('${userId}')"]`);
      if (followBtn) followBtn.textContent = 'Following';
    }
    createNotification(userId, 'follow');
  }

  // ==================== SETTINGS (fixed) ====================
  async function loadSettings() {
    if (!currentUser) {
      goToPage('home');
      return;
    }
    try {
      let { data: settings, error } = await _supabase
        .from('user_settings')
        .select('*')
        .eq('user_id', currentUser.id)
        .maybeSingle();

      if (error) throw error;
      if (!settings) {
        const { error: insertError } = await _supabase
          .from('user_settings')
          .insert({ user_id: currentUser.id });
        if (insertError) throw insertError;
        settings = { email_notifications: true };
      }

      const html = `
        <div class="p-4 max-w-lg">
          <h2 class="text-2xl font-bold mb-4">Settings</h2>
          <form id="settings-form" class="space-y-4">
            <div>
              <label class="block text-sm">Display name</label>
              <input type="text" id="settings-display-name" value="${escapeHTML(currentProfile?.display_name || '')}" class="w-full bg-black border border-stash rounded-lg p-3">
            </div>
            <div>
              <label class="block text-sm">Bio</label>
              <textarea id="settings-bio" rows="3" class="w-full bg-black border border-stash rounded-lg p-3">${escapeHTML(currentProfile?.bio || '')}</textarea>
            </div>
            <div>
              <label class="block text-sm">Avatar URL</label>
              <input type="url" id="settings-avatar" value="${escapeHTML(currentProfile?.avatar_url || '')}" class="w-full bg-black border border-stash rounded-lg p-3">
            </div>
            <div>
              <label class="block text-sm">Banner URL</label>
              <input type="url" id="settings-banner" value="${escapeHTML(currentProfile?.banner_url || '')}" class="w-full bg-black border border-stash rounded-lg p-3">
            </div>
            <div class="flex items-center gap-2">
              <input type="checkbox" id="settings-email" ${settings?.email_notifications ? 'checked' : ''} class="w-4 h-4">
              <label for="settings-email" class="text-sm">Email notifications</label>
            </div>
            <button type="submit" class="bg-stash-blue text-white px-6 py-2 rounded-full">Save</button>
          </form>
          <hr class="my-4 border-stash">
          <button onclick="changePassword()" class="bg-gray-700 text-white px-6 py-2 rounded-full">Change password</button>
        </div>
      `;
      mainContent.innerHTML = html;
      document.getElementById('settings-form').addEventListener('submit', saveSettings);
    } catch (err) {
      console.error('Settings error:', err);
      mainContent.innerHTML = '<div class="p-4 text-red-500">Failed to load settings. Please try again.</div>';
    }
  }

  async function saveSettings(e) {
    e.preventDefault();
    const display_name = document.getElementById('settings-display-name').value.trim();
    const bio = document.getElementById('settings-bio').value.trim();
    const avatar_url = document.getElementById('settings-avatar').value.trim() || null;
    const banner_url = document.getElementById('settings-banner').value.trim() || null;
    const email_notifications = document.getElementById('settings-email').checked;
    await _supabase.from('profiles').update({ display_name, bio, avatar_url, banner_url }).eq('id', currentUser.id);
    await _supabase.from('user_settings').update({ email_notifications }).eq('user_id', currentUser.id);
    alert('Settings saved');
    fetchCurrentProfile();
    updateAuthUI(currentUser);
    if (currentPage === 'profile') loadProfile(currentUser.id);
  }

  async function changePassword() {
    const newPass = prompt('Enter new password (min 6 characters)');
    if (newPass && newPass.length >= 6) {
      const { error } = await _supabase.auth.updateUser({ password: newPass });
      if (error) alert(error.message);
      else alert('Password updated');
    }
  }

  // ==================== WITHDRAWALS ====================
  window.openWithdrawModal = (balance) => {
    document.getElementById('withdraw-balance').textContent = `$${parseFloat(balance).toFixed(2)}`;
    document.getElementById('withdraw-modal').classList.remove('hidden');
  };

  document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUser) return;
    const balance = parseFloat(document.getElementById('withdraw-balance').textContent.slice(1));
    const amount = parseFloat(document.getElementById('withdraw-amount').value);
    if (amount > balance) { alert('Amount exceeds balance'); return; }
    const method = document.getElementById('withdraw-method').value;
    const address = document.getElementById('withdraw-address').value.trim();
    if (!amount || !method || !address) return;
    const { error } = await _supabase.from('withdrawals').insert({
      user_id: currentUser.id,
      amount,
      method,
      address,
      status: 'pending'
    });
    if (error) alert('Withdrawal request failed: ' + error.message);
    else {
      alert('Withdrawal request submitted. Admin will review.');
      closeModal('withdraw-modal');
    }
  });

  // ==================== ADMIN DASHBOARD (fully implemented) ====================
  window.openAdminDashboard = async () => {
    document.getElementById('admin-modal').classList.remove('hidden');
    await loadAdminDashboard();
  };

  async function loadAdminDashboard() {
    const { count: users } = await _supabase.from('profiles').select('*', { count: 'exact', head: true });
    const { count: postsCount } = await _supabase.from('posts').select('*', { count: 'exact', head: true });
    const { data: viewsData } = await _supabase.from('posts').select('views');
    const totalViews = (viewsData || []).reduce((a,b) => a + (b.views||0), 0);
    const { data: earnings } = await _supabase.from('user_earnings').select('total_earned');
    const totalEarnings = (earnings || []).reduce((a,b) => a + (b.total_earned||0), 0);

    const panes = `
      <div class="tab-pane active" data-pane="dashboard">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-stash-dark p-4 rounded">Users: ${users || 0}</div>
          <div class="bg-stash-dark p-4 rounded">Posts: ${postsCount || 0}</div>
          <div class="bg-stash-dark p-4 rounded">Views: ${totalViews}</div>
          <div class="bg-stash-dark p-4 rounded">Revenue: $${totalEarnings.toFixed(5)}</div>
        </div>
      </div>
      <div class="tab-pane hidden" data-pane="users"><h3 class="text-lg font-bold mb-4">Users</h3><div id="admin-users-list" class="space-y-2"></div></div>
      <div class="tab-pane hidden" data-pane="posts"><h3 class="text-lg font-bold mb-4">Posts</h3><div id="admin-posts-list" class="space-y-2"></div></div>
      <div class="tab-pane hidden" data-pane="trends">
        <h3 class="text-lg font-bold mb-4">Trends</h3>
        <form id="add-trend-form" class="flex gap-2 mb-4">
          <input type="text" id="new-hashtag" placeholder="New hashtag" class="flex-1 bg-black border border-stash rounded-lg p-2">
          <button type="submit" class="bg-stash-blue text-white px-4 py-2 rounded-lg">Add</button>
        </form>
        <div id="admin-trends-list" class="space-y-2"></div>
      </div>
      <div class="tab-pane hidden" data-pane="ads">
        <h3 class="text-lg font-bold mb-4">Ads</h3>
        <button onclick="showAddAdForm()" class="bg-stash-blue text-white px-4 py-2 rounded-lg mb-4">Add New Ad</button>
        <div id="admin-ads-list" class="space-y-2"></div>
      </div>
      <div class="tab-pane hidden" data-pane="withdrawals">
        <h3 class="text-lg font-bold mb-4">Withdrawals</h3>
        <div id="admin-withdrawals-list" class="space-y-2"></div>
      </div>
      <div class="tab-pane hidden" data-pane="analytics">
        <canvas id="admin-chart" width="400" height="200"></canvas>
      </div>
    `;
    document.getElementById('admin-panes').innerHTML = panes;

    loadAdminUsers();
    loadAdminPosts();
    loadAdminTrends();
    loadAdminAds();
    loadAdminWithdrawals();
    initAdminChart();

    document.querySelectorAll('.admin-tab').forEach(btn => {
      btn.removeEventListener('click', adminTabHandler);
      btn.addEventListener('click', adminTabHandler);
    });
  }

  function adminTabHandler(e) {
    const btn = e.currentTarget;
    document.querySelectorAll('.admin-tab').forEach(b => {
      b.classList.remove('active', 'text-stash-blue', 'border-b-2', 'border-stash-blue');
      b.classList.add('text-gray-500');
    });
    btn.classList.add('active', 'text-stash-blue', 'border-b-2', 'border-stash-blue');
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
    document.querySelector(`.tab-pane[data-pane="${btn.dataset.tab}"]`).classList.remove('hidden');
  }

  // Admin: Users
  async function loadAdminUsers() {
    const { data: users } = await _supabase.from('profiles').select('id, username, display_name, is_admin').order('created_at');
    const list = document.getElementById('admin-users-list');
    if (!list) return;
    list.innerHTML = (users || []).map(u => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <div>
          <span class="font-bold">${escapeHTML(u.display_name || u.username)}</span> @${escapeHTML(u.username)} ${u.is_admin ? 'ðŸ‘‘' : ''}
        </div>
        <div>
          <button onclick="toggleAdmin('${u.id}', ${!u.is_admin})" class="bg-stash-blue text-white px-3 py-1 rounded text-sm mr-2">${u.is_admin ? 'Remove admin' : 'Make admin'}</button>
          <button onclick="deleteUser('${u.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
        </div>
      </div>
    `).join('');
  }

  window.toggleAdmin = async (userId, makeAdmin) => {
    await _supabase.from('profiles').update({ is_admin: makeAdmin }).eq('id', userId);
    loadAdminUsers();
  };

  window.deleteUser = async (userId) => {
    if (!confirm('Delete this user? All their posts, likes, etc. will be deleted.')) return;
    await _supabase.from('profiles').delete().eq('id', userId);
    loadAdminUsers();
  };

  // Admin: Posts
  async function loadAdminPosts() {
    const { data: posts } = await _supabase
      .from('posts')
      .select('*, profiles(username)')
      .order('created_at', { ascending: false });
    const list = document.getElementById('admin-posts-list');
    if (!list) return;
    list.innerHTML = (posts || []).map(p => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <div>
          <span class="font-bold">@${escapeHTML(p.profiles?.username)}</span>: ${escapeHTML(p.content?.substring(0,50))}... <span class="text-gray-500 text-sm">${timeAgo(p.created_at)}</span>
          <p class="text-xs">Monetization: ${p.monetization_approved ? 'âœ… Approved' : (p.views >= 500 ? 'â³ Requested' : 'âŒ None')}</p>
        </div>
        <div>
          ${!p.monetization_approved && p.views >= 500 ? `<button onclick="approveMonetization('${p.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm mr-2">Approve</button>` : ''}
          <button onclick="deletePostAdmin('${p.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
        </div>
      </div>
    `).join('');
  }

  window.approveMonetization = async (postId) => {
    await _supabase.from('posts').update({ monetization_approved: true }).eq('id', postId);
    loadAdminPosts();
  };

  window.deletePostAdmin = async (postId) => {
    if (!confirm('Delete this post?')) return;
    await _supabase.from('posts').delete().eq('id', postId);
    loadAdminPosts();
    loadHomeFeed(true);
  };

  // Admin: Trends
  async function loadAdminTrends() {
    const { data } = await _supabase.from('trends').select('*').order('post_count', { ascending: false });
    const list = document.getElementById('admin-trends-list');
    if (!list) return;
    list.innerHTML = (data || []).map(t => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <span>#${t.hashtag} (${t.post_count} posts)</span>
        <button onclick="deleteTrend('${t.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
      </div>
    `).join('');
  }

  document.getElementById('add-trend-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const hashtag = document.getElementById('new-hashtag').value.trim();
    if (!hashtag) return;
    await _supabase.from('trends').insert({ hashtag, post_count: 1 });
    document.getElementById('new-hashtag').value = '';
    loadAdminTrends();
  });

  window.deleteTrend = async (trendId) => {
    await _supabase.from('trends').delete().eq('id', trendId);
    loadAdminTrends();
  };

  // Admin: Ads
  async function loadAdminAds() {
    const { data } = await _supabase.from('ads').select('*').order('created_at');
    const list = document.getElementById('admin-ads-list');
    if (!list) return;
    list.innerHTML = (data || []).map(ad => `
      <div class="flex justify-between items-center border border-stash p-3 rounded">
        <div class="flex items-center gap-3">
          <img src="${escapeHTML(ad.image_url)}" class="w-12 h-12 object-cover rounded">
          <span>${escapeHTML(ad.promoted_text)}</span> ${ad.active ? 'ðŸŸ¢' : 'ðŸ”´'}
        </div>
        <div>
          <button onclick="editAd('${ad.id}')" class="bg-stash-blue text-white px-3 py-1 rounded text-sm mr-2">Edit</button>
          <button onclick="deleteAd('${ad.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Delete</button>
          <button onclick="toggleAdActive('${ad.id}', ${!ad.active})" class="bg-gray-600 text-white px-3 py-1 rounded text-sm">${ad.active ? 'Deactivate' : 'Activate'}</button>
        </div>
      </div>
    `).join('');
  }

  window.showAddAdForm = () => openAdModal(null, { image_url: '', link_url: '', promoted_text: 'Promoted', active: true });
  window.editAd = async (adId) => {
    const { data } = await _supabase.from('ads').select('*').eq('id', adId).single();
    if (data) openAdModal(adId, data);
  };
  window.toggleAdActive = async (adId, newState) => {
    await _supabase.from('ads').update({ active: newState }).eq('id', adId);
    loadAdminAds();
  };
  window.deleteAd = async (adId) => {
    if (!confirm('Delete this ad?')) return;
    await _supabase.from('ads').delete().eq('id', adId);
    loadAdminAds();
  };

  function openAdModal(id, ad) {
    const existing = document.querySelector('.ad-modal-instance');
    if (existing) existing.remove();
    const modal = document.createElement('div');
    modal.className = 'ad-modal-instance fixed inset-0 modal-overlay flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
      <div class="bg-black border border-stash rounded-2xl w-full max-w-md p-6">
        <h2 class="text-2xl font-bold mb-4">${id ? 'Edit Ad' : 'New Ad'}</h2>
        <form id="ad-form">
          <input type="hidden" id="ad-id" value="${id || ''}">
          <div class="space-y-3">
            <input type="url" id="ad-image" placeholder="Image URL" value="${escapeHTML(ad.image_url)}" class="w-full bg-black border border-stash rounded-lg p-3" required>
            <input type="url" id="ad-link" placeholder="Link URL" value="${escapeHTML(ad.link_url || '')}" class="w-full bg-black border border-stash rounded-lg p-3">
            <input type="text" id="ad-promoted" placeholder="Promoted text" value="${escapeHTML(ad.promoted_text)}" class="w-full bg-black border border-stash rounded-lg p-3">
            <div class="flex items-center gap-2">
              <input type="checkbox" id="ad-active" ${ad.active ? 'checked' : ''} class="w-4 h-4">
              <label>Active</label>
            </div>
            <div class="flex gap-2">
              <button type="submit" class="bg-stash-blue text-white px-4 py-2 rounded-lg flex-1">Save</button>
              <button type="button" onclick="this.closest('.ad-modal-instance').remove()" class="bg-gray-700 text-white px-4 py-2 rounded-lg">Cancel</button>
            </div>
          </div>
        </form>
      </div>
    `;
    document.body.appendChild(modal);
    document.getElementById('ad-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const image_url = document.getElementById('ad-image').value.trim();
      const link_url = document.getElementById('ad-link').value.trim() || null;
      const promoted_text = document.getElementById('ad-promoted').value.trim() || 'Promoted';
      const active = document.getElementById('ad-active').checked;
      const id = document.getElementById('ad-id').value;
      if (!image_url) { alert('Image URL required'); return; }
      const adData = { image_url, link_url, promoted_text, active };
      if (id) {
        await _supabase.from('ads').update(adData).eq('id', id);
      } else {
        await _supabase.from('ads').insert([adData]);
      }
      modal.remove();
      loadAdminAds();
    });
  }

  // Admin: Withdrawals
  async function loadAdminWithdrawals() {
    const { data } = await _supabase.from('withdrawals').select('*, profiles(username)').order('created_at', { ascending: false });
    const list = document.getElementById('admin-withdrawals-list');
    if (!list) return;
    list.innerHTML = (data || []).map(w => `
      <div class="border border-stash p-3 rounded">
        <p><strong>@${escapeHTML(w.profiles?.username)}</strong> requested $${w.amount} via ${w.method}</p>
        <p class="text-sm text-gray-400">Address: ${escapeHTML(w.address)} Â· Status: ${w.status}</p>
        ${w.status === 'pending' ? `<button onclick="approveWithdrawal('${w.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-sm mt-2">Approve</button>` : ''}
      </div>
    `).join('');
  }

  window.approveWithdrawal = async (id) => {
    await _supabase.from('withdrawals').update({ status: 'approved' }).eq('id', id);
    loadAdminWithdrawals();
  };

  // Admin: Analytics (real data)
  async function initAdminChart() {
    const ctx = document.getElementById('admin-chart')?.getContext('2d');
    if (!ctx) return;
    const labels = [];
    const data = [];
    for (let i = 6; i >= 0; i--) {
      const d = new Date();
      d.setDate(d.getDate() - i);
      const day = d.toISOString().split('T')[0];
      labels.push(day.slice(5));
      const { count } = await _supabase
        .from('posts')
        .select('*', { count: 'exact', head: true })
        .gte('created_at', day + 'T00:00:00')
        .lt('created_at', new Date(d.getTime() + 86400000).toISOString().split('T')[0] + 'T00:00:00');
      data.push(count || 0);
    }
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label: 'Posts', data, borderColor: '#1d9bf0' }] }
    });
  }

  // ==================== INIT ====================
  const mainContent = document.getElementById('main-content');
  loadPage('home');
</script>

<!-- ==================== SQL (run in Supabase) ====================
CREATE TABLE IF NOT EXISTS withdrawals (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  amount DECIMAL(10,2) NOT NULL,
  method TEXT NOT NULL,
  address TEXT NOT NULL,
  status TEXT DEFAULT 'pending',
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE OR REPLACE FUNCTION increment_user_earnings(p_user_id UUID, amount DECIMAL)
RETURNS void AS $$
BEGIN
  INSERT INTO user_earnings (user_id, total_earned)
  VALUES (p_user_id, amount)
  ON CONFLICT (user_id) DO UPDATE
  SET total_earned = user_earnings.total_earned + amount,
      last_updated = now();
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
-->
</body>
  </html>
